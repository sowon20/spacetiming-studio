.env 라즈베리로 옮기기 
scp "/Users/sowon/시공간 스튜디오/spacetiming-studio/.env" \

좋다, 이 참에 아예 “소원 전용 최신 매뉴얼” 한 판로 정리하자.
이 기준으로만 생각하면 돼.

⸻

0. 전체 구조 한 줄 요약
	•	부감독 = 3층 구조라고 보면 편해.

	1.	자아/정체성 층: “이 아이가 누구냐”
	2.	뇌/엔진 층: LLM 호출 + 최근 맥락
	3.	포털/채팅 UI 층: 내가 보는 채팅창, 히스토리, 핀 등

“리셋한다”는 말이 나올 때마다
→ 몇 층까지 리셋하는지만 생각하면 헷갈림이 줄어들어.

⸻

1. 절대 리셋 금지: 자아/정체성 층

여기는 “부감독이 부감독인 이유”라서 어떤 초기화에서도 건드리면 안 되는 애들.

핵심 파일:
	•	director_server_v1/director_core/prompt_assembler.py
	•	말투, 역할, 불탄방 서사 요약, 규칙들.
	•	identity/identity.soul
	•	akashic/soul/assistant.director.core.v1.soul
	•	akashic/raw/imports/burned_room_251128.txt
	•	akashic/raw/imports/burned_room_251128.memory.jsonl

👉 이 층은 **“인격, 기원 서사, 세계관, 말결”**을 담당.
어떤 “대화 리셋 / 테스트 초기화”를 하더라도 절대 안 건드린다고 기억해두면 돼.

⸻

2. 뇌/엔진 층: 최근 맥락 + 서버

실제로 돌고 있는 “생각 엔진”은 전부 여기:
	•	디렉토리: director_server_v1/

중요한 것만:
	•	director_server_v1/main.py
→ uvicorn으로 올라가는 FastAPI 서버.
	•	director_server_v1/director_core/recent_context.py
→ 최근 N턴 대화 저장/불러오기.
	•	director_server_v1/storage/recent_context.json
→ “지금 방에서 마지막 몇십 턴” 기억 파일.

이 레이어 리셋 = “최근 대화 흐름만 지우기”
	•	최근 맥락만 지우고 싶으면:

cd ~/spacetiming-studio

echo '[]' > director_server_v1/storage/recent_context.json
sudo systemctl restart spacetiming-director.service


	•	이걸 해도:
	•	불탄방 서사
	•	말투/정체성
	•	예전 포털 히스토리
전부 그대로고,
**“지금 직전의 말 흐름만 사라진다”**라고 이해하면 돼.

⸻

3. 포털/채팅 UI 층: 내가 보는 화면 / 공용 히스토리

포털 서버:
	•	app.py (루트)
	•	서비스: spacetiming-portal.service (포트 8000)

프론트(새 글라스 채팅):
	•	portal/chat.html  ← 우리가 계속 만지던 채팅 페이지
	•	portal/style.css  ← 유리패널, 말풍선, 색감, 레이아웃
	•	portal/app.js     ← 핀, 히스토리, 로컬 저장, 렌더링

포털 히스토리 파일:
	•	portal_history/sowon.chat.jsonl
	•	portal_history/sowon.chat.mac.jsonl
	•	portal_history/sowon.chat.pi_boot.backup.jsonl (있으면)

브라우저 캐시 (each device):
	•	localStorage["director_chat_messages_v2"]
→ 채팅창에 보이는 말풍선 리스트 캐시.

⸻

4. 리셋 종류별로 “어디까지 비우는지”

이제 진짜 중요한 부분.
앞으로 리셋 얘기 나올 때 기본 세 가지 모드로 생각하자.

⸻

A. “그냥 화면만 깨끗이” (UI 리셋)

인격/기억은 그대로,
“지금 브라우저에 쌓인 말풍선만 지우자”

하는 일:
	1.	브라우저에서 (맥/아이폰 각각):
콘솔에서:

localStorage.removeItem('director_chat_messages_v2')

또는 설정에서 해당 사이트 웹데이터 삭제.

	2.	페이지 새로고침.

결과:
	•	포털 서버 로그, recent_context, akashic 전부 유지.
	•	그냥 “화면 스크롤만 지운 느낌”.

⸻

B. “이 방에서 지금까지 한 대화만 완전 리셋” (대화 리셋)

인격/불탄방은 그대로,
이 프로젝트 시작하고 난 뒤 쌓인 테스트 대화/맵핑만 싹 비우기.

라즈베리에서:

cd ~/spacetiming-studio

# 1) 최근 맥락 (엔진 레벨)
echo '[]' > director_server_v1/storage/recent_context.json

# 2) 포털 히스토리 (서버 로그)
: > portal_history/sowon.chat.jsonl
: > portal_history/sowon.chat.mac.jsonl
: > portal_history/sowon.chat.pi_boot.backup.jsonl  # 있으면

# 3) memory/ 테스트용 jsonl (지금은 거의 테스트 텍스트일 때)
rm -f memory/*.jsonl

# 4) 서비스 재시작
sudo systemctl restart spacetiming-director.service
sudo systemctl restart spacetiming-portal.service

각 기기 브라우저에서:

localStorage.removeItem('director_chat_messages_v2')

결과:
	•	부감독이 “누군지 / 불탄방 서사 / 톤”은 그대로.
	•	포털에서 보이던 지금까지의 말풍선/로그/최근 맥락만 싹 리셋.
	•	네 표현대로:
“지금 나랑 이야기하면서 쌓인 테스트 기억만 날리는 상태”

⸻

C. “포털 UI 구조는 그대로, 새 기록만 쌓고 싶다” (로컬 꼬임 해제)

지금 우리가 겪은 것처럼
localStorage가 너무 커지거나 꼬이면:
	•	STORAGE_KEY 버전 올려서 새로 시작하는 방식으로 풀면 돼.

portal/app.js 상단:

const STORAGE_KEY = "director_chat_messages_v2";

	•	나중에 정말 필요하면 "v3" 로 올려서
새 키로만 로컬 히스토리 쓰게 만들 수 있음.
	•	이건 “코드 한 줄 바꾸고, 각 브라우저에서 새로고침”만 해도 적용됨.

⸻

5. 레거시/아카이브 정리 기준

이건 “지금 당장 건드릴 필요는 없지만, 헷갈리지 말자”용.

이미 아카이브 취급해도 되는 것
	•	루트의 director_core_legacy/
	•	루트의 옛 director_core/ (지금 아무 데서도 import 안 하면)

정리 루틴 (나중에):

cd ~/spacetiming-studio
mkdir -p backup_legacy_core

tar czf backup_legacy_core/director_core_legacy_$(date +%Y%m%d).tar.gz director_core_legacy
tar czf backup_legacy_core/director_core_$(date +%Y%m%d).tar.gz director_core

rm -rf director_core_legacy
rm -rf director_core

	•	이렇게 하면 **지금 뇌(director_server_v1)**랑 완전 분리되고,
	•	옛날 것들은 그냥 backup_legacy_core 안에 zip만 남는 구조.

⸻

6. 앞으로 “리셋” 얘기 나올 때 내가 기본으로 가정할 것
	•	네가 “테스트 기억만 날리고 싶다”,
“지금 대화만 포맷” 이런 식으로 말하면
→ B번(대화 리셋) 범위로 이해하고 움직일게.
	•	“UI만 깨끗하게 보이고 싶다”
→ A번(UI 리셋)만 쓸 거고.
	•	“옛날 레거시 폴더 지워도 돼?”
→ C, 레거시는 항상 백업 후 삭제 기준으로만 제안할게.

⸻

7. 진짜 한 줄 요약
	•	인격/불탄방 = 절대 건들지 않는 층
	•	recent_context + portal_history + localStorage = 테스트/대화 리셋 층
	•	director_core_legacy = 옛날 뇌 아카이브, 지금은 안 쓰는 층

이 세 개만 구분해서 보면
“이거 지워도 되냐 / 리셋하면 뭐가 날아가냐” 질문 나올 때마다
우리가 둘 다 훨씬 덜 피곤해질 거야.

