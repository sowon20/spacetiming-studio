<!doctype html>
<!--
  chat.html
  - ì‹œê³µê°„ ìŠ¤íŠœë””ì˜¤ í¬í„¸ ë©”ì¸ í™”ë©´
  - í”„ë¡ íŠ¸ ë¡œì§: portal/app.js
  - ë°±ì—”ë“œ: app.py (/api/chat, /api/history)
  - ìƒë‹¨ API ì‚¬ìš©ëŸ‰ ë°”/í¼ì„¼íŠ¸ ê°’ì€ í˜„ì¬ëŠ” ì‹œê°ì  ì¥ì‹ìš©ì´ë©°, ì‹¤ì œ ì‚¬ìš©ëŸ‰ê³¼ëŠ” ì—°ë™ë˜ì§€ ì•ŠëŠ”ë‹¤.
-->
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Sowon Â· Chat Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- iOS í™ˆ í™”ë©´ / í’€ìŠ¤í¬ë¦°ìš© ë©”íƒ€ -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Spacetime Director" />
  <!-- (ì„ íƒ) ì•„ì´ì½˜ íŒŒì¼ì´ ìˆì„ ê²½ìš° ì´ ê²½ë¡œì— ë‘ë©´ í™ˆí™”ë©´ ì•„ì´ì½˜ ì‚¬ìš© ê°€ëŠ¥ -->
  <link rel="apple-touch-icon" href="/static/icons/app-icon-192.png" />
  <meta name="theme-color" content="#1a1c1a" />
  <style>
    :root {
      --vh: 1vh;
      --bg-cream: #f4f0ea;
      --bg-cream-soft: #efe9e0;
      --sage-deep: #323732;
      --sage-mid: #3d433e;
      --sage-soft: #5a635b;
      --sand-deep: #8b7965;
      --text-main: #262522;
      --text-soft: #96938e;
      --text-softer: #aaa7a2;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-y: hidden; /* í™ˆì•± ê¸°ì¤€: ì „ì²´ í˜ì´ì§€ëŠ” ìŠ¤í¬ë¡¤ ë§‰ê³ , ì±„íŒ… ì˜ì—­ë§Œ ìŠ¤í¬ë¡¤ */
      overflow-x: hidden;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color: var(--text-main);
      -webkit-text-size-adjust: 100%;
      background: #000000; /* ì „ì²´ ê¸°ë³¸ ë°°ê²½ì€ ê²€ì • */
    }

    body.app-bg-forest {
      background-image: url("/static/backgrounds/forest_book.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      min-height: 100vh;
    }
    /* Ensure no body.app-bg-forest::before exists */

    .app {
      position: fixed;
      inset: 0;
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1;
    }

    /* ìƒë‹¨ íŒ¨ë„ */

    .top-panel {
      background: rgba(12, 14, 12, 0.72);
      border-radius: 18px;
      padding: 10px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: #e8e3db;
      backdrop-filter: blur(16px) saturate(140%);
      -webkit-backdrop-filter: blur(16px) saturate(140%);
      box-shadow: 0 18px 40px rgba(5, 7, 6, 0.55);
      transition: max-height 0.25s ease, opacity 0.25s ease, background-color 0.2s ease, padding 0.2s ease, gap 0.2s ease;
      margin-top: -6px; /* ê·¸ë¼ë°ì´ì…˜ ì†ìœ¼ë¡œ ì‚´ì§ íŒŒë¬»í˜€ ë³´ì´ê²Œ */
      cursor: pointer;
    }

    /* ìƒë‹¨ íŒ¨ë„ì´ í™•ì¥ ìƒíƒœì¼ ë•Œ (ê¸°ë³¸ë³´ë‹¤ ì¡°ê¸ˆ ë” ë„“ê²Œ) */
    .top-panel.expanded {
      padding: 14px 16px;
      gap: 10px;
    }


    .top-panel-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .top-title-main {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .top-title-sub {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 2px;
    }

    .status-pill {
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(10, 12, 10, 0.32);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4bd37b;
    }

    .api-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      opacity: 0.9;
    }

    .api-label {
      opacity: 0.75;
    }

    .api-bar-wrap {
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: rgba(230, 224, 214, 0.22);
      overflow: hidden;
    }

    .api-bar {
      height: 100%;
      width: 32%;
      background: #e8e3db;
    }

    .top-actions {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }

    .icon-btn {
      border: none;
      outline: none;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: rgba(10, 10, 10, 0.4);
      color: #f5f2ec;
      font-size: 17px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }

    .icon-btn span {
      display: none;
    }

    .icon-btn:active {
      transform: scale(0.97);
    }

    /* í•€ ìº¡ìŠ */

    .pin-strip {
      min-height: 0;
    }

    .pin-capsule {
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(60, 67, 62, 0.22);
      font-size: 11px;
      color: #f2ede5;
    }

    .pin-capsule-main {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
    }

    .pin-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #f7e3a2;
      flex-shrink: 0;
    }

    .pin-text {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .pin-close {
      border: none;
      outline: none;
      background: none;
      color: #d9d3c8;
      font-size: 13px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .pin-close:active {
      transform: scale(0.9);
    }

    /* ë©”ì‹œì§€ ì˜ì—­ */

    .messages {
      flex: 1 1 auto;
      min-height: 0;
      padding: 8px 4px;
      border-radius: 18px;
      background: rgba(255, 255, 255, 0.16);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow-y: auto;
      overflow-x: visible;      /* ë§í’ì„  ë©”ë‰´ê°€ ì˜ë¦¬ì§€ ì•Šë„ë¡ */
      -webkit-overflow-scrolling: auto; /* iOS ê³ ë¬´ì¤„/ë¯¸ëŒë¯¸ëŒ íš¨ê³¼ ì¤„ì´ê¸° */
      font-size: 13px;
      position: relative;
    }

        /* í’€ìŠ¤í¬ë¦° ì´ë¯¸ì§€ ë·°ì–´ */
    .image-viewer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.96);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .image-viewer-overlay.show {
      display: flex;
    }

    .image-viewer-overlay img {
      max-width: 100vw;
      max-height: 100vh;
      object-fit: contain;
    }

    .image-viewer-close {
      position: absolute;
      top: 18px;
      right: 18px;
      font-size: 18px;
      color: #f4f0ea;
      background: rgba(0, 0, 0, 0.45);
      border-radius: 999px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }


    /* ìœ„ë¡œ ëŒì–´ì„œ ìƒˆë¡œê³ ì¹¨ í‘œì‹œ */
    .pull-indicator {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 10px;
      text-align: center;
      font-size: 11px;
      padding: 4px 0;
      color: var(--text-soft);
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.15s ease, transform 0.15s ease, color 0.15s ease;
      pointer-events: none;
    }

    .pull-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }

    .pull-indicator.ready {
      color: #f7e3a2;
    }

    .timeline-divider {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px 0;
      font-size: 11px;
      color: #e8e3db;
      opacity: 0.8;
    }

    .timeline-divider::before,
    .timeline-divider::after {
      content: "";
      flex: 1;
      border-bottom: 2px dotted rgba(232, 227, 219, 0.9);
      margin: 0 10px;
    }

    .messages-inner {
      padding: 4px 4px 72px;
    }

    .msg-row {
      display: flex;
      margin-bottom: 6px;
    }

    .msg-row.other {
      justify-content: flex-start;
    }

    .msg-row.me {
      justify-content: flex-end;
    }

    .bubble-wrap {
      max-width: 78%;
      position: relative;
      display: inline-flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
    }

    .bubble {
      position: relative;
      padding: 8px 10px;
      border-radius: 18px;
      font-size: 13px;
      line-height: 1.4;
      word-break: break-word;
      white-space: pre-wrap; /* Shift+Enter ì¤„ë°”ê¿ˆ ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ê¸° */
      transition: transform 0.08s ease-out, background-color 0.08s ease-out;
    }

    .bubble.other {
      background: var(--bg-cream-soft);
      color: var(--text-main);
      border-bottom-left-radius: 6px;
    }

    .bubble.me {
      background: var(--sage-mid);
      color: #f3eee5;
      border-bottom-right-radius: 6px;
    }

    .bubble.press-feedback {
      transform: scale(0.985);
    }

    .msg-row.other .bubble.press-feedback {
      background-color: rgba(239, 233, 224, 0.96);
    }

    .msg-row.me .bubble.press-feedback {
      background-color: #4a534b;
    }

    .bubble.typing {
      opacity: 0.9;
      letter-spacing: 0;
    }

    .typing-dots {
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: currentColor;
      opacity: 0.25;
      animation: typingBlink 1s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.15s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes typingBlink {
      0% {
        opacity: 0.2;
        transform: translateY(0);
      }
      30% {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      60% {
        opacity: 0.4;
        transform: translateY(0);
      }
      100% {
        opacity: 0.2;
        transform: translateY(0);
      }
    }


    .bubble-meta {
      font-size: 10px;
      color: #d6d2cc;
      align-self: flex-end;
      padding: 0 2px;
    }

    .msg-row.other .bubble-meta {
      align-self: flex-start;
      padding-left: 2px;
    }

    .msg-row.me .bubble-meta {
      align-self: flex-end;
      padding-right: 2px;
    }

    .retry-btn {
      margin-top: 4px;
      align-self: flex-end;
      border: none;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      background: rgba(200, 80, 80, 0.16);
      color: #f5e2e2;
      cursor: pointer;
    }

    .retry-btn:active {
      transform: scale(0.95);
    }

    /* ë§í’ì„  ë©”ë‰´ */

    .bubble-menu-toggle {
      position: absolute;
      top: 50%;
      transform: translateY(-100%);
      width: 10px;
      height: 10px;
      border: none;
      border-radius: 999px;
      background: transparent;
      padding: 0;
      font-size: 0;
      opacity: 0;
      pointer-events: none; /* ë§í’ì„  ë¡±í”„ë ˆìŠ¤ ë©”ë‰´ë¡œ ëŒ€ì²´ */
    }
    .bubble.has-attachments {
      border: 1px solid rgba(255, 255, 255, 0.18); /* ì²¨ë¶€ê°€ ìˆëŠ” ë²„ë¸”ë§Œ ì‚´ì§ í…Œë‘ë¦¬ */
    }

    .msg-row.other .bubble.has-attachments {
      border-color: rgba(0, 0, 0, 0.08);
    }

    .bubble-attachments {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .bubble-attachment {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 6px;
      border-radius: 999px;
      font-size: 11px;
    }

    .bubble-attachment.image {
      padding: 0;
      border-radius: 12px;
      background: transparent;
    }

    .bubble-attachment-thumb {
      display: block;
      max-width: 180px;
      max-height: 180px;
      border-radius: 12px;
      object-fit: cover;
    }

    .msg-row.other .bubble-attachment {
      background: rgba(0, 0, 0, 0.03);
      color: var(--text-soft);
    }

    .msg-row.me .bubble-attachment {
      background: rgba(255, 255, 255, 0.12);
      color: #f5f2ec;
    }

    .bubble-attachment-icon {
      font-size: 11px;
      flex-shrink: 0;
    }

    .bubble-attachment-name {
      max-width: 140px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .msg-row.other .bubble-menu-toggle {
      right: -14px;
      left: auto;
      color: var(--bg-cream-soft); /* same tone as assistant bubble */
    }

    .msg-row.me .bubble-menu-toggle {
      left: -14px;
      right: auto;
      color: var(--sage-mid); /* same tone as my bubble */
    }

    .bubble-menu-toggle:active {
      opacity: 0.8; /* ì‚´ì§ë§Œ ëˆŒë¦¬ëŠ” ëŠë‚Œ, ìœ„ì¹˜ëŠ” ê·¸ëŒ€ë¡œ */
    }

    .bubble-menu {
      position: absolute;
      right: 0;
      top: -28px;               /* ë§í’ì„  ìœ„ë¡œ ë„ìš°ê¸° */
      display: none;
      background: rgba(45, 50, 46, 0.9); /* ê¸°ë³¸: ìƒëŒ€ ë©”ì‹œì§€ìš© */
      border-radius: 999px;
      padding: 3px 6px;
      font-size: 11px;
      color: #f2eee5;
      white-space: nowrap;
      gap: 4px;
      align-items: center;
      z-index: 20;              /* ë²„ë¸”ë³´ë‹¤ ìœ„ë¡œ */
    }
    .msg-row.me .bubble-menu {
      left: auto;
      right: 0;
      background: rgb(21, 21, 21); /* ë‚´ ë©”ì‹œì§€ìš©: ë” ì§„í•œ ë°°ê²½ */
    }

    .bubble-menu.show {
      display: inline-flex;
    }

    .bubble-menu button {
      border: none;
      background: none;
      padding: 3px 4px;
      border-radius: 999px;
      color: inherit;
      cursor: pointer;
    }

    .bubble-menu button:active {
      transform: scale(0.9);
    }

    /* ì‘ì„± ì˜ì—­ */

    .composer {
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .attach-strip {
      display: none;
      padding: 6px 0;
      border-radius: 10px;
      background: transparent;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .attach-strip-inner {
      display: inline-flex;
      gap: 8px;
    }

    .attach-pill {
      width: 80px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
    }

    .attach-thumb {
      position: relative;
      width: 100%;
      padding-top: 100%; /* ì •ì‚¬ê°í˜• */
      border-radius: 12px;
      background: rgba(244, 240, 234, 0.96);
      overflow: hidden;
    }
    .attach-thumb img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .attach-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: none;
      background: rgba(0, 0, 0, 0.5);
      color: #f8f4ed;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .attach-title {
      display: none;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      text-align: center;
      color: var(--text-main);
    }

    .composer-hint {
      font-size: 10px;
      color: var(--text-soft);
      padding: 0 2px;
    }


    .composer-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .attach-btn {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: none;
      outline: none;
      background: rgba(244, 240, 234, 0.98); /* ê±°ì˜ í°ìƒ‰ */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      cursor: pointer;
      color: var(--sage-mid);
      flex-shrink: 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
    }

    .attach-btn:active {
      transform: scale(0.95);
    }

    .input-shell {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      padding: 6px 8px 6px 10px;
      border-radius: 16px;
      background: rgba(244, 240, 234, 0.9);
    }

    textarea.input {
      flex: 1;
      border: none;
      background: transparent;
      resize: none;
      outline: none;
      font: inherit;
      font-size: 16px;
      line-height: 1.4;
      max-height: 88px;
      color: var(--text-main);
    }

    .send-btn {
      border: none;
      outline: none;
      margin-left: 6px;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: var(--sage-mid);
      color: #f3eee5;
      font-size: 14px;
    }

    .send-btn:active {
      transform: scale(0.95);
    }

    @media (min-width: 768px) {
      .app {
        max-width: 480px;
        margin: 0 auto;
      }
    }
    .messages::-webkit-scrollbar {
      width: 4px;
    }

    .messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages::-webkit-scrollbar-thumb {
      background: rgba(90, 99, 91, 0.55);
      border-radius: 999px;
    }

    .messages {
      scrollbar-width: thin;
      scrollbar-color: rgba(90, 99, 91, 0.55) transparent;
    }
    /* ê°€ë¡œ ëª¨ë“œ ì•ˆë‚´ í…ìŠ¤íŠ¸ (í˜„ì¬ëŠ” ì‚¬ìš© ì•ˆ í•¨, ì•±ì€ í•­ìƒ í‘œì‹œ) */
    .landscape-warning {
      display: none;
    }

    @media (orientation: landscape) and (max-width: 900px) {
      .landscape-warning {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
        background: rgba(10, 10, 10, 0.9);
        color: #f4f0ea;
        font-size: 14px;
        text-align: center;
      }
    }
  </style>
</head>
<body class="app-bg-forest">
  <div class="app">
    <input type="file" id="bgImageInput" accept="image/*" style="display:none" />
    <!-- ìƒë‹¨ ì„¸ì´ì§€ íŒ¨ë„ -->
    <header class="top-panel">
      <div class="top-panel-row">
        <div>
          <div class="top-title-main">SPACETIME DIRECTOR</div>
          <div class="top-title-sub">ë¶€ê°ë… Â· ê°œì¸ ì„¸ì…˜</div>
        </div>
        <div class="top-actions">
          <div class="status-pill">
            <span class="status-dot"></span>
            <span>ONLINE</span>
          </div>
          <button class="icon-btn" type="button" id="bgChangeBtn">
            ğŸ¨<span>BG</span>
          </button>
          <button class="icon-btn" type="button">
            ğŸ“<span>Call</span>
          </button>
        </div>
      </div>
      <div class="api-row">
        <div class="api-label">API ì‚¬ìš©ëŸ‰</div>
        <div class="api-bar-wrap">
          <div class="api-bar" id="apiBar"></div>
        </div>
        <div class="api-label" id="apiLabel">32%</div>
      </div>
    </header>

    <!-- í•€ ìº¡ìŠ ì˜ì—­ -->
    <section class="pin-strip">
      <div class="pin-capsule" id="pinCapsule">
        <div class="pin-capsule-main">
          <div class="pin-dot"></div>
          <div class="pin-text" id="pinText">í•€ ëœ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ìš”ì•½ë¼ìš”.</div>
        </div>
        <button class="pin-close" type="button" id="pinClearBtn">âœ•</button>
      </div>
    </section>

    <!-- ë©”ì‹œì§€ ì˜ì—­ -->
    <main class="messages" id="messages">
      <div class="messages-inner" id="messagesInner">
        <!-- ì‹¤ì œ ë©”ì‹œì§€ëŠ” JSì—ì„œ ë Œë”ë§ -->
      </div>
      <div class="pull-indicator" id="pullIndicator">ğŸ”„ ìœ„ë¡œ ì˜¬ë¦¬ë©´ ì´ì „ ëŒ€í™” ë³´ê¸°</div>
    </main>

    <!-- ì…ë ¥ ì˜ì—­ -->
    <section class="composer">
      <input type="file" id="fileInput" multiple style="display:none" />
      <!-- ì²¨ë¶€ ë¯¸ë¦¬ë³´ê¸° (í˜„ì¬ëŠ” ë¡œì»¬ ë¯¸ë¦¬ë³´ê¸° ì „ìš©, ì‹¤ì œ ì—…ë¡œë“œëŠ” app.js TODO ì°¸ê³ ) -->
      <div class="attach-strip" id="attachStrip">
        <div class="attach-strip-inner" id="attachStripInner">
          <!-- JSë¡œ ì±„ì›Œì§ -->
        </div>
      </div>

      <div class="composer-row">
        <button class="attach-btn" type="button" id="attachBtn">ï¼‹</button>
        <div class="input-shell">
          <textarea
            id="input"
            class="input"
            rows="1"
            placeholder="ë©”ì‹œì§€ ì…ë ¥â€¦"
          ></textarea>
          <button class="send-btn" type="button" id="sendBtn">â¤</button>
        </div>
      </div>
    </section>
  </div>
  <div class="image-viewer-overlay" id="imageViewer">
    <button type="button" class="image-viewer-close" id="imageViewerClose">âœ•</button>
    <img id="imageViewerImg" alt="attachment preview" />
  </div>
  <script>
    const messagesInner = document.getElementById("messagesInner");
    const pinCapsule = document.getElementById("pinCapsule");
    const pinText = document.getElementById("pinText");
    const pinClearBtn = document.getElementById("pinClearBtn");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const attachBtn = document.getElementById("attachBtn");
    const attachStrip = document.getElementById("attachStrip");
    const attachStripInner = document.getElementById("attachStripInner");
    const fileInput = document.getElementById("fileInput");
    const messagesEl = document.getElementById("messages");
    const pullIndicator = document.getElementById("pullIndicator");

    const bodyEl = document.body;
    const bgImageInput = document.getElementById("bgImageInput");
    const bgChangeBtn = document.getElementById("bgChangeBtn");
        const imageViewer = document.getElementById("imageViewer");
    const imageViewerImg = document.getElementById("imageViewerImg");
    const imageViewerClose = document.getElementById("imageViewerClose");

    function openImageViewer(url) {
      if (!imageViewer || !imageViewerImg || !url) return;
      imageViewerImg.src = url;
      imageViewer.classList.add("show");
    }

    if (imageViewer) {
      imageViewer.addEventListener("click", (e) => {
        // ë°°ê²½(ê²€ì€ ì˜ì—­)ì„ íƒ­í•˜ë©´ ë‹«íˆê²Œ
        if (e.target === imageViewer) {
          imageViewer.classList.remove("show");
        }
      });
    }

    if (imageViewerClose) {
      imageViewerClose.addEventListener("click", () => {
        imageViewer.classList.remove("show");
      });
    }

    const TYPING_ROW_ID = "assistant-typing";

    const STORAGE_KEY = "director_chat_messages_v2";
    // const UPLOAD_PROFILE_KEY = "director_upload_profile";
    let uploadProfile = "local_default";
    let chatHistory = [];
    let pendingAttachments = [];
    let isComposing = false;
    const INITIAL_HISTORY_BATCH = 40;
    const HISTORY_PAGE_SIZE = 40;
    let visibleStartIndex = 0;
    let isLoadingOlder = false;
    let currentBgObjectUrl = null;
    let isSending = false; // ì—”í„°/ë²„íŠ¼ ì¤‘ë³µ ì…ë ¥ìœ¼ë¡œ ì¸í•œ ì¤‘ë³µ ì „ì†¡ ë°©ì§€

    // ë·°í¬íŠ¸ ë†’ì´ ë™ê¸°í™”: í‚¤ë³´ë“œê°€ ì˜¬ë¼ì™€ë„ .app ë†’ì´ë¥¼ ì‹¤ì œ í™”ë©´ì— ë§ê²Œ ì¡°ì •
    function updateViewportHeight() {
      const vv = window.visualViewport;
      const height = vv ? vv.height : window.innerHeight;
      const vh = height * 0.01;
      document.documentElement.style.setProperty("--vh", `${vh}px`);
    }

    // ì´ˆê¸° í•œ ë²ˆ + iOSì—ì„œ í‚¤ë³´ë“œ ì—´ë¦¬ê³  ë‹«íŒ ë’¤ ì•ˆì •í™”ìš© í•œ ë²ˆ ë”
    window.addEventListener("load", () => {
      updateViewportHeight();
      setTimeout(updateViewportHeight, 150);
    });

    if (window.visualViewport) {
      window.visualViewport.addEventListener("resize", updateViewportHeight);
    } else {
      window.addEventListener("resize", updateViewportHeight);
      window.addEventListener("orientationchange", updateViewportHeight);
    }


    // ë°°ê²½ ì´ë¯¸ì§€ ë³€ê²½: ì•„ì´í° ì‚¬ì§„ì²©ì—ì„œ ì„ íƒí•´ì„œ í˜„ì¬ ì„¸ì…˜ ë°°ê²½ìœ¼ë¡œ ì‚¬ìš©
    if (bgChangeBtn && bgImageInput && bodyEl) {
      bgChangeBtn.addEventListener("click", () => {
        bgImageInput.click();
      });

      bgImageInput.addEventListener("change", (e) => {
        const input = e.target;
        const file = input.files && input.files[0];
        if (!file || !file.type || !file.type.startsWith("image/")) {
          // ì´ë¯¸ì§€ê°€ ì•„ë‹ˆë©´ ë¬´ì‹œ
          input.value = "";
          return;
        }

        // ì´ì „ ë°°ê²½ URL ì •ë¦¬
        if (currentBgObjectUrl) {
          try {
            URL.revokeObjectURL(currentBgObjectUrl);
          } catch (_) {
            // ignore
          }
          currentBgObjectUrl = null;
        }

        const url = URL.createObjectURL(file);
        currentBgObjectUrl = url;

        // body ë°°ê²½ì„ ì„ íƒí•œ ì´ë¯¸ì§€ë¡œ êµì²´
        bodyEl.style.backgroundImage = `url("${url}")`;
        bodyEl.style.backgroundSize = "cover";
        bodyEl.style.backgroundPosition = "center";
        bodyEl.style.backgroundRepeat = "no-repeat";

        // ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒí•´ë„ change ì´ë²¤íŠ¸ê°€ ëœ¨ë„ë¡ ì´ˆê¸°í™”
        input.value = "";
      });
    }

    // ìƒë‹¨ íŒ¨ë„ í™•ì¥/ê¸°ë³¸ í† ê¸€ (ê¸°ë³¸: ì§€ê¸ˆ í¬ê¸°, í´ë¦­ ì‹œ ì¡°ê¸ˆ ë” ë„“ê²Œ)
    const topPanel = document.querySelector(".top-panel");
    if (topPanel) {
      let isTopPanelExpanded = false;
      topPanel.addEventListener("click", (e) => {
        // ì•„ì´ì½˜ ë²„íŠ¼(ë°°ê²½/ì „í™”)ì„ ëˆ„ë¥¼ ë•ŒëŠ” í† ê¸€ ë§‰ê¸°
        if (e.target.closest(".icon-btn")) {
          return;
        }
        isTopPanelExpanded = !isTopPanelExpanded;
        if (isTopPanelExpanded) {
          topPanel.classList.add("expanded");
        } else {
          topPanel.classList.remove("expanded");
        }
      });
    }

    async function fetchServerHistory(limit = 200) {
      try {
        const resp = await fetch(`/api/history?limit=${limit}`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        // ì§€ì› í˜•íƒœ: [ {..}, {..} ] ë˜ëŠ” { messages: [..] }
        const raw = Array.isArray(data)
          ? data
          : Array.isArray(data?.messages)
          ? data.messages
          : [];

        return raw.map((item, idx) => {
          const ts =
            item.timestamp !== undefined && item.timestamp !== null
              ? item.timestamp
              : item.time !== undefined
              ? item.time
              : null;

          // ì„œë²„ì—ì„œ ì²¨ë¶€ ì •ë³´ê°€ í•¨ê»˜ ì˜¬ ê²½ìš° ê·¸ëŒ€ë¡œ ë³´ì¡´
          const attachments = Array.isArray(item.attachments)
            ? item.attachments
            : Array.isArray(item.files)
            ? item.files
            : [];

          return {
            id:
              item.id ||
              String(ts || Date.now()) + "_" + idx.toString(),
            role: item.role || "assistant",
            content: item.content || "",
            timestamp: ts,
            attachments,
          };
        });
      } catch (e) {
        console.warn("server history failed", e);
        return [];
      }
    }

    function loadHistory() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.warn("chat history load failed", e);
        return [];
      }
    }

    function saveHistory() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory));
      } catch (e) {
        console.warn("chat history save failed", e);
      }
    }

    function formatTime(ts) {
      // ì˜ˆì „ í˜•ì‹: "HH:MM" ë¬¸ìì—´ë¡œë§Œ ì €ì¥ëœ ê²½ìš°ëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©
      if (typeof ts === "string" && ts.length >= 5 && ts[2] === ":") {
        return ts.slice(0, 5);
      }

      let d = null;

      if (typeof ts === "string") {
        const parsed = new Date(ts);
        if (!isNaN(parsed.getTime())) {
          d = parsed;
        }
      } else if (typeof ts === "number") {
        const parsed = new Date(ts);
        if (!isNaN(parsed.getTime())) {
          d = parsed;
        }
      }

      if (!d) {
        d = new Date();
      }

      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");

      // í•­ìƒ ì ˆëŒ€ ì‹œê°„ìœ¼ë¡œ í‘œì‹œ: YYYY-MM-DD HH:MM
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function createMessage(role, content, timestamp, attachments) {
      return {
        id: Date.now().toString() + Math.random().toString(16).slice(2),
        role,
        content,
        timestamp: timestamp ?? Date.now(),
        attachments: Array.isArray(attachments) ? attachments : [],
        status: "ok",
      };
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // ì•„ì£¼ ê°€ë²¼ìš´ ì¸ë¼ì¸ ë§ˆí¬ë‹¤ìš´: **bold**, *italic*, `code`
    function renderContent(raw) {
      if (!raw) return "";
      let text = escapeHtml(raw);

      // bold: **text**
      text = text.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
      // italic: *text*
      text = text.replace(/\*(.+?)\*/g, "<em>$1</em>");
      // inline code: `code`
      text = text.replace(/`([^`]+)`/g, "<code>$1</code>");

      return text;
    }

    function truncateFileName(name, maxLen = 24) {
      const str = String(name || "ì²¨ë¶€íŒŒì¼");
      if (str.length <= maxLen) return str;
      const extIndex = str.lastIndexOf(".");
      if (extIndex > 0 && extIndex < str.length - 1) {
        const base = str.slice(0, extIndex);
        const ext = str.slice(extIndex);
        if (base.length > maxLen - ext.length - 3) {
          return base.slice(0, maxLen - ext.length - 3) + "..." + ext;
        }
        return base + "..." + ext;
      }
      return str.slice(0, maxLen - 3) + "...";
    }

    const LONG_PRESS_MS = 500;
    const LONG_PRESS_MOVE_TOLERANCE = 10;
    let longPressTimer = null;
    let longPressTargetWrap = null;
    let longPressTargetBubble = null;
    let longPressStartX = 0;
    let longPressStartY = 0;

    let lastTapTime = 0;
    let lastTapBubble = null;
    const DOUBLE_TAP_MS = 350;

    function openBubbleMenuForWrap(wrap) {
      if (!wrap) return;
      const menu = wrap.querySelector(".bubble-menu");
      if (!menu) return;

      // ê¸°ì¡´ì— ì—´ë ¤ ìˆë˜ ë©”ë‰´ëŠ” ëª¨ë‘ ë‹«ê¸°
      const allMenus = document.querySelectorAll(".bubble-menu");
      allMenus.forEach((m) => {
        if (m !== menu) m.classList.remove("show");
      });

      // ì¼ë‹¨ ë³´ì´ê²Œ ë§Œë“  ë’¤, ë¡±í”„ë ˆìŠ¤ ì¢Œí‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ ê³„ì‚°
      menu.classList.add("show");
      menu.style.bottom = "auto";

      if (messagesEl) {
        requestAnimationFrame(() => {
          const wrapRect = wrap.getBoundingClientRect();
          const menuRect = menu.getBoundingClientRect();
          const messagesRect = messagesEl.getBoundingClientRect();

          // ë¡±í”„ë ˆìŠ¤ ìœ„ì¹˜ê°€ ê¸°ë¡ë˜ì–´ ìˆìœ¼ë©´ ê·¸ ê·¼ì²˜ì—, ì•„ë‹ˆë©´ ë§í’ì„  ì¤‘ì•™ ê¸°ì¤€
          const pressY = longPressStartY || (wrapRect.top + wrapRect.height / 2);

          // ê¸°ë³¸ì€ ì†ê°€ë½ ë°”ë¡œ ìœ„ìª½ì— ë©”ë‰´ë¥¼ ë‘ëŠ” ë°©í–¥ìœ¼ë¡œ ê³„ì‚°
          let menuTopInViewport = pressY - menuRect.height - 8;

          // ë©”ë‰´ê°€ ìƒë‹¨ ë©”ì‹œì§€ ì˜ì—­ ë°–ìœ¼ë¡œ íŠ€ì–´ë‚˜ê°€ë©´, ì†ê°€ë½ ì•„ë˜ìª½ìœ¼ë¡œ ì¬ë°°ì¹˜
          if (menuTopInViewport < messagesRect.top + 8) {
            menuTopInViewport = pressY + 8;
          }

          // ë‹¤ì‹œ wrap ë‚´ë¶€ ì¢Œí‘œê³„ë¡œ ë³€í™˜
          let localTop = menuTopInViewport - wrapRect.top;

          // ë„ˆë¬´ ì•„ë˜ë¡œ ë‚´ë ¤ê°€ì„œ ë©”ì‹œì§€ ì˜ì—­ ë°”ë‹¥ì„ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ì‚´ì§ í´ë¨í”„
          const maxTop = messagesRect.bottom - menuRect.height - wrapRect.top - 8;
          if (localTop > maxTop) {
            localTop = maxTop;
          }

          menu.style.top = `${localTop}px`;
        });
      } else {
        // messagesElì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ê³ ì • ìœ„ì¹˜ ì‚¬ìš©
        menu.style.top = "-28px";
      }
    }

    function cancelLongPress() {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
      if (longPressTargetBubble) {
        longPressTargetBubble.classList.remove("press-feedback");
      }
      longPressTargetWrap = null;
      longPressTargetBubble = null;
    }

    function handlePressStart(event) {
      const bubble = event.target.closest(".bubble");
      if (!bubble) return;
      const wrap = bubble.closest(".bubble-wrap");
      if (!wrap) return;

      // ì´ì „ ë¡±í”„ë ˆìŠ¤ ìƒíƒœ ì´ˆê¸°í™”
      cancelLongPress();

      longPressTargetBubble = bubble;
      bubble.classList.add("press-feedback");

      // iOSì—ì„œ í…ìŠ¤íŠ¸ ë‹ë³´ê¸°/ê¸°ë³¸ ë¡±í”„ë ˆìŠ¤ ë©”ë‰´ê°€ ëœ¨ì§€ ì•Šë„ë¡ ë§‰ê¸°
      if (event.touches && event.cancelable) {
        event.preventDefault();
      }

      longPressTargetWrap = wrap;
      const point = event.touches ? event.touches[0] : event;
      longPressStartX = point.clientX;
      longPressStartY = point.clientY;

      longPressTimer = setTimeout(() => {
        openBubbleMenuForWrap(longPressTargetWrap);
        longPressTimer = null;
      }, LONG_PRESS_MS);
    }

    function handlePressMove(event) {
      if (!longPressTimer) return;
      const point = event.touches ? event.touches[0] : event;
      if (!point) return;
      const dx = Math.abs(point.clientX - longPressStartX);
      const dy = Math.abs(point.clientY - longPressStartY);
      if (dx > LONG_PRESS_MOVE_TOLERANCE || dy > LONG_PRESS_MOVE_TOLERANCE) {
        cancelLongPress();
      }
    }

    function handlePressEnd() {
      cancelLongPress();
    }

    function handleBubbleTap(bubble) {
      const now = Date.now();
      if (lastTapBubble === bubble && now - lastTapTime < DOUBLE_TAP_MS) {
        const range = document.createRange();
        range.selectNodeContents(bubble);
        const selection = window.getSelection();
        if (selection) {
          selection.removeAllRanges();
          selection.addRange(range);
        }
      }
      lastTapBubble = bubble;
      lastTapTime = now;
    }

    function clearPendingAttachments() {
      pendingAttachments.forEach((att) => {
        if (att.url) {
          URL.revokeObjectURL(att.url);
        }
      });
      pendingAttachments = [];
      attachStripInner.innerHTML = "";
      attachStrip.style.display = "none";
    }

    function addFilesToAttachments(files) {
      const list = Array.from(files || []);
      if (!list.length) return;

      list.forEach((file) => {
        const id = Date.now().toString() + Math.random().toString(16).slice(2);
        const url = URL.createObjectURL(file);
        const isImage = file.type && file.type.startsWith("image/");

        const att = { id, file, url, isImage };
        pendingAttachments.push(att);

        attachStrip.style.display = "block";

        const pill = document.createElement("div");
        pill.className = "attach-pill";
        pill.dataset.id = id;

        const thumb = document.createElement("div");
        thumb.className = "attach-thumb";

        if (isImage) {
          const img = document.createElement("img");
          img.src = url;
          img.alt = file.name || "image";
          thumb.appendChild(img);
        } else {
          const label = document.createElement("div");
          label.style.position = "absolute";
          label.style.inset = "0";
          label.style.display = "flex";
          label.style.alignItems = "center";
          label.style.justifyContent = "center";
          label.style.fontSize = "10px";
          label.style.color = "var(--text-soft)";
          const name = (file.name || "íŒŒì¼").split(".");
          label.textContent = name.length > 1 ? name.pop().toUpperCase() : "FILE";
          thumb.appendChild(label);
        }

        const remove = document.createElement("button");
        remove.className = "attach-remove";
        remove.type = "button";
        remove.textContent = "âœ•";
        remove.addEventListener("click", () => {
          pill.remove();
          pendingAttachments = pendingAttachments.filter((x) => {
            if (x.id === id) {
              if (x.url) URL.revokeObjectURL(x.url);
              return false;
            }
            return true;
          });
          if (!attachStripInner.children.length) {
            attachStrip.style.display = "none";
          }
        });
        thumb.appendChild(remove);

        const title = document.createElement("div");
        title.className = "attach-title";
        title.textContent = file.name || "ì²¨ë¶€íŒŒì¼";

        pill.appendChild(thumb);
        pill.appendChild(title);
        attachStripInner.appendChild(pill);
      });

      if (fileInput) {
        fileInput.value = "";
      }
    }

    async function uploadPendingFiles() {
      if (!pendingAttachments.length) return [];
      const formData = new FormData();
      pendingAttachments.forEach((att) => {
        if (att.file) {
          formData.append("files", att.file, att.file.name || "file");
        }
      });
      formData.append("upload_profile", uploadProfile || "local_default");

      try {
        const resp = await fetch("/api/upload", {
          method: "POST",
          body: formData,
        });
        if (!resp.ok) {
          throw new Error("upload failed: " + resp.status);
        }
        const data = await resp.json();
        const files = Array.isArray(data?.files) ? data.files : [];
        return files;
      } catch (e) {
        console.error("upload error", e);
        return [];
      }
    }

    function showTypingIndicator() {
      if (document.getElementById(TYPING_ROW_ID)) return;

      const row = document.createElement("div");
      row.className = "msg-row other";
      row.id = TYPING_ROW_ID;

      const wrap = document.createElement("div");
      wrap.className = "bubble-wrap";

      const bubble = document.createElement("div");
      bubble.className = "bubble other typing";

      const dots = document.createElement("div");
      dots.className = "typing-dots";

      for (let i = 0; i < 3; i++) {
        const dot = document.createElement("span");
        dot.className = "typing-dot";
        dots.appendChild(dot);
      }

      bubble.appendChild(dots);
      wrap.appendChild(bubble);
      row.appendChild(wrap);
      messagesInner.appendChild(row);
      scrollToBottom();
    }

    function hideTypingIndicator() {
      const typingRow = document.getElementById(TYPING_ROW_ID);
      if (typingRow) {
        typingRow.remove();
      }
    }

    function buildMessageRowElement(msg) {
      // ì‹œìŠ¤í…œ ì—­í•  ë©”ì‹œì§€ëŠ” íƒ€ì„ë¼ì¸ êµ¬ë¶„ì„ ìœ¼ë¡œ ë Œë”ë§
      if (msg.role === "system") {
        const div = document.createElement("div");
        div.className = "timeline-divider";
        const span = document.createElement("span");
        span.textContent = msg.content || "";
        div.appendChild(span);
        return div;
      }

      const row = document.createElement("div");
      row.className = "msg-row " + (msg.role === "assistant" ? "other" : "me");

      const wrap = document.createElement("div");
      wrap.className = "bubble-wrap";
      wrap.dataset.id = msg.id;

      const toggle = document.createElement("button");
      toggle.className = "bubble-menu-toggle";
      toggle.type = "button";
      toggle.textContent = "â‹¯";

      const bubble = document.createElement("div");
      bubble.className = "bubble " + (msg.role === "assistant" ? "other" : "me");
      bubble.innerHTML = renderContent(msg.content);

      if (Array.isArray(msg.attachments) && msg.attachments.length) {
        bubble.classList.add("has-attachments");
        const attWrap = document.createElement("div");
        attWrap.className = "bubble-attachments";

        msg.attachments.forEach((att) => {
          const chip = document.createElement("div");

          // kind / type / íŒŒì¼ í™•ì¥ìë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì´ë¯¸ì§€ ì—¬ë¶€ íŒë³„
          let kind = att.kind || "file";
          const type = typeof att.type === "string" ? att.type : "";

          // typeì´ ë¹„ì–´ ìˆìœ¼ë©´ íŒŒì¼ ì´ë¦„ í™•ì¥ìë¡œ ì¶”ë¡ 
          let ext = "";
          if (att.name && typeof att.name === "string" && att.name.includes(".")) {
            const parts = att.name.split(".");
            ext = parts[parts.length - 1].toLowerCase();
          }
          const isExtImage = ["jpg", "jpeg", "png", "gif", "webp", "heic", "heif", "bmp"].includes(ext);

          if (!att.kind) {
            if (type.startsWith("image/") || (!type && isExtImage)) {
              kind = "image";
            } else if (type.startsWith("video/")) {
              kind = "video";
            } else {
              kind = "file";
            }
          }

          chip.className = "bubble-attachment";
          if (kind === "image") {
            chip.classList.add("image");
          }

          if (kind === "image" && att.url) {
            // ì´ë¯¸ì§€ì˜ ê²½ìš° ë§í’ì„  ì•ˆì— ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°
            const img = document.createElement("img");
            img.className = "bubble-attachment-thumb";
            img.src = att.url;
            img.alt = att.name || "image";
            // í´ë¦­ ì‹œ ìƒˆ íƒ­ìœ¼ë¡œ í¬ê²Œ ë³´ê¸°
            img.addEventListener("click", () => {
              openImageViewer(att.url);
            });
            chip.appendChild(img);
          } else {
            // ê·¸ ì™¸(íŒŒì¼/ì˜ìƒ)ëŠ” ì•„ì´ì½˜ + íŒŒì¼ëª… ì¹©ìœ¼ë¡œ í‘œì‹œ
            const icon = document.createElement("span");
            icon.className = "bubble-attachment-icon";
            icon.textContent =
              kind === "image" ? "ğŸ–¼" : kind === "video" ? "ğŸ¬" : "ğŸ“";

            const label = document.createElement("span");
            label.className = "bubble-attachment-name";
            label.textContent = truncateFileName(att.name || "ì²¨ë¶€íŒŒì¼");

            chip.appendChild(icon);
            chip.appendChild(label);
          }

          attWrap.appendChild(chip);
        });

        bubble.appendChild(attWrap);
      }

      const meta = document.createElement("div");
      meta.className = "bubble-meta" + (msg.role === "assistant" ? "" : " me");
      meta.textContent = formatTime(msg.timestamp);

      const menu = document.createElement("div");
      menu.className = "bubble-menu";
      ["pin", "copy", "edit", "delete", "history"].forEach((action) => {
        const btn = document.createElement("button");
        btn.dataset.action = action;
        btn.textContent =
          action === "pin"
            ? "í•€"
            : action === "copy"
            ? "ë³µì‚¬"
            : action === "edit"
            ? "ìˆ˜ì •"
            : action === "delete"
            ? "ì‚­ì œ"
            : "ê¸°ë¡";
        menu.appendChild(btn);
      });

      wrap.appendChild(toggle);
      wrap.appendChild(bubble);
      wrap.appendChild(meta);
      wrap.appendChild(menu);
      row.appendChild(wrap);
      return row;
    }

    function markMessageAsFailed(msgId) {
      if (!msgId) return;

      // chatHistory ë‚´ ìƒíƒœ í”Œë˜ê·¸ ì—…ë°ì´íŠ¸
      const target = chatHistory.find((m) => m.id === msgId);
      if (target) {
        target.status = "error";
      }

      const wrap = messagesInner.querySelector(
        '.bubble-wrap[data-id="' + msgId + '"]'
      );
      if (!wrap) return;

      // ì´ë¯¸ ì¬ì „ì†¡ ë²„íŠ¼ì´ ìˆë‹¤ë©´ ì¤‘ë³µìœ¼ë¡œ ë§Œë“¤ì§€ ì•Šê¸°
      if (wrap.querySelector(".retry-btn")) return;

      const meta = wrap.querySelector(".bubble-meta");
      if (meta) {
        meta.textContent = (meta.textContent || "") + " Â· ì „ì†¡ ì‹¤íŒ¨";
      }

      const retryBtn = document.createElement("button");
      retryBtn.type = "button";
      retryBtn.className = "retry-btn";
      retryBtn.textContent = "ë‹¤ì‹œ ë³´ë‚´ê¸°";

      retryBtn.addEventListener("click", () => {
        retrySend(msgId);
      });

      wrap.appendChild(retryBtn);
    }

    async function retrySend(msgId) {
      const msg = chatHistory.find((m) => m.id === msgId);
      if (!msg || isSending) return;

      isSending = true;
      showTypingIndicator();

      try {
        const resp = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            messages: [{ role: "user", content: msg.content }],
            attachments: Array.isArray(msg.attachments) ? msg.attachments : [],
            upload_profile: uploadProfile,
          }),
        });

        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }

        const data = await resp.json();
        const replyText =
          data && typeof data.reply === "string" ? data.reply.trim() : "";

        hideTypingIndicator();

        if (replyText) {
          const assistantMsg = createMessage("assistant", replyText);
          chatHistory.push(assistantMsg);
          appendMessageToDOM(assistantMsg);
          saveHistory();
          scrollToBottom();
        }

        // ì„±ê³µ ì‹œ ì‹¤íŒ¨ í‘œì‹œ ì œê±°
        const wrap = messagesInner.querySelector(
          '.bubble-wrap[data-id="' + msgId + '"]'
        );
        if (wrap) {
          const retryBtn = wrap.querySelector(".retry-btn");
          if (retryBtn) retryBtn.remove();
          const meta = wrap.querySelector(".bubble-meta");
          if (meta) {
            meta.textContent = meta.textContent.replace(" Â· ì „ì†¡ ì‹¤íŒ¨", "");
          }
        }
      } catch (err) {
        console.error("retrySend error", err);
        hideTypingIndicator();
      } finally {
        isSending = false;
      }
    }
    // ë¡±í”„ë ˆìŠ¤(ëª¨ë°”ì¼/ë°ìŠ¤í¬íƒ‘)ë¡œ ë§í’ì„  ë©”ë‰´ ì—´ê¸°
    messagesInner.addEventListener("touchstart", handlePressStart, { passive: false });
    messagesInner.addEventListener("touchmove", handlePressMove, { passive: true });
    messagesInner.addEventListener("touchend", handlePressEnd);
    messagesInner.addEventListener("touchcancel", handlePressEnd);

    messagesInner.addEventListener("mousedown", (e) => {
      if (e.button !== 0) return;
      handlePressStart(e);
    });
    messagesInner.addEventListener("mousemove", handlePressMove);
    messagesInner.addEventListener("mouseup", handlePressEnd);
    messagesInner.addEventListener("mouseleave", handlePressEnd);

    function appendMessageToDOM(msg, options = {}) {
      const { prepend = false } = options;
      const row = buildMessageRowElement(msg);
      if (prepend && messagesInner.firstChild) {
        messagesInner.insertBefore(row, messagesInner.firstChild);
      } else if (prepend) {
        messagesInner.appendChild(row);
      } else {
        messagesInner.appendChild(row);
      }
    }

    async function renderHistory() {
      // ì„œë²„ íˆìŠ¤í† ë¦¬ë¥¼ ê¸°ì¤€ìœ¼ë¡œ, ì—†ì„ ë•Œë§Œ ë¡œì»¬ ìºì‹œ ì‚¬ìš©
      const serverMsgs = await fetchServerHistory(1000);
      let base = [];

      if (Array.isArray(serverMsgs) && serverMsgs.length > 0) {
        base = serverMsgs;
      } else {
        const localMsgs = loadHistory();
        base = Array.isArray(localMsgs) ? localMsgs : [];
      }

      // íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë˜ëœ ê²ƒ â†’ ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬ (ê°™ì€ ì‹œê°ì´ë©´ ì›ë˜ ìˆœì„œ ìœ ì§€)
      if (base.length) {
        const withOrder = base.map((m, idx) => ({ ...m, _order: idx }));

        withOrder.sort((a, b) => {
          const ta = a.timestamp ?? 0;
          const tb = b.timestamp ?? 0;
          const da = typeof ta === "string" ? new Date(ta).getTime() : ta;
          const db = typeof tb === "string" ? new Date(tb).getTime() : tb;

          if (da === db) {
            return a._order - b._order;
          }
          return da - db;
        });

        base = withOrder.map(({ _order, ...rest }) => rest);
      }

      chatHistory = base;
      messagesInner.innerHTML = "";

      const total = chatHistory.length;
      visibleStartIndex = Math.max(0, total - INITIAL_HISTORY_BATCH);

      for (let i = visibleStartIndex; i < total; i++) {
        appendMessageToDOM(chatHistory[i]);
      }

      // ì„œë²„ ê¸°ì¤€ ìƒíƒœë¥¼ localStorageì—ë„ ë°±ì—…ì²˜ëŸ¼ ì €ì¥
      saveHistory();
      scrollToBottom();
    }

    async function loadOlderMessages() {
      if (isLoadingOlder) return;
      if (!messagesEl) return;
      if (visibleStartIndex <= 0) return;

      isLoadingOlder = true;

      const prevStart = Math.max(0, visibleStartIndex - HISTORY_PAGE_SIZE);
      const prevScrollTop = messagesEl.scrollTop;
      const prevScrollHeight = messagesEl.scrollHeight;

      for (let i = visibleStartIndex - 1; i >= prevStart; i--) {
        appendMessageToDOM(chatHistory[i], { prepend: true });
      }

      visibleStartIndex = prevStart;

  const newScrollHeight = messagesEl.scrollHeight;
  const heightDiff = newScrollHeight - prevScrollHeight;
  messagesEl.scrollTop = prevScrollTop + heightDiff;

  isLoadingOlder = false;

  if (pullIndicator) {
    pullIndicator.textContent = "â†‘ ìœ„ë¡œ ì˜¬ë¦¬ë©´ ì´ì „ ëŒ€í™” ë³´ê¸°";
  }
}

    // (pull-to-refresh ë©”ì‹œì§€ ì˜ì—­ ê´€ë ¨ ì½”ë“œ ì œê±°ë¨)

    if (messagesEl) {
  messagesEl.addEventListener("scroll", () => {
    const nearTop = messagesEl.scrollTop <= 40;
    const hasMore = visibleStartIndex > 0;

    if (nearTop && hasMore) {
      if (pullIndicator) {
        pullIndicator.classList.add("show");
        pullIndicator.textContent = isLoadingOlder
          ? "ì´ì „ ëŒ€í™” ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦"
          : "â†‘ ìœ„ë¡œ ì˜¬ë¦¬ë©´ ì´ì „ ëŒ€í™” ë³´ê¸°";
      }

      if (!isLoadingOlder) {
        loadOlderMessages();
      }
    } else {
      if (pullIndicator) {
        pullIndicator.classList.remove("show");
      }
    }
  });
}

    // ì•„ë˜ìª½ì—ì„œ ìœ„ë¡œ ê¸¸ê²Œ ëŒì–´ì˜¬ë¦¬ë©´ ì „ì²´ ìƒˆë¡œê³ ì¹¨
    if (messagesEl) {
      let pullFromBottomStartY = 0;
      let pullFromBottomActive = false;
      let pullFromBottomDistance = 0;
      const BOTTOM_THRESHOLD_PX = 90;
      const BOTTOM_EDGE_TOLERANCE = 20;

      messagesEl.addEventListener(
        "touchstart",
        (e) => {
          if (!e.touches || !e.touches.length) return;
          const t = e.touches[0];

          // ê±°ì˜ ë§¨ ì•„ë˜ì— ìˆì„ ë•Œë§Œ "ì•„ë˜ì—ì„œ ìœ„ë¡œ" ì œìŠ¤ì²˜ ì¸ì‹ ì‹œì‘
          const scrollBottom =
            messagesEl.scrollHeight - messagesEl.clientHeight - messagesEl.scrollTop;
          if (scrollBottom <= BOTTOM_EDGE_TOLERANCE) {
            pullFromBottomActive = true;
            pullFromBottomStartY = t.clientY;
            pullFromBottomDistance = 0;
          } else {
            pullFromBottomActive = false;
          }
        },
        { passive: true }
      );

      messagesEl.addEventListener(
        "touchmove",
        (e) => {
          if (!pullFromBottomActive || !e.touches || !e.touches.length) return;
          const t = e.touches[0];
          pullFromBottomDistance = pullFromBottomStartY - t.clientY; // ìœ„ë¡œ ëŒìˆ˜ë¡ ì–‘ìˆ˜

          if (pullFromBottomDistance > 10 && pullIndicator) {
            pullIndicator.classList.add("show");
            if (pullFromBottomDistance > BOTTOM_THRESHOLD_PX) {
              pullIndicator.classList.add("ready");
              pullIndicator.textContent = "ğŸ”„ ë†“ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨";
            } else {
              pullIndicator.classList.remove("ready");
              pullIndicator.textContent = "ğŸ”„ ìœ„ë¡œ ëŒì–´ì˜¬ë¦¬ë©´ ìƒˆë¡œê³ ì¹¨";
            }
          }
        },
        { passive: true }
      );

      messagesEl.addEventListener("touchend", () => {
        if (pullFromBottomActive && pullFromBottomDistance > BOTTOM_THRESHOLD_PX) {
          if (pullIndicator) {
            pullIndicator.classList.remove("ready");
            pullIndicator.textContent = "ğŸ”„ ìƒˆë¡œê³ ì¹¨ ì¤‘â€¦";
          }
          // ì ê¹ í…ìŠ¤íŠ¸ê°€ ë³´ì´ë„ë¡ ì•½ê°„ ì§€ì—° í›„ ìƒˆë¡œê³ ì¹¨
          setTimeout(() => {
            location.reload();
          }, 350);
        } else if (pullIndicator) {
          pullIndicator.classList.remove("show");
          pullIndicator.classList.remove("ready");
          pullIndicator.textContent = "ğŸ”„ ìœ„ë¡œ ì˜¬ë¦¬ë©´ ì´ì „ ëŒ€í™” ë³´ê¸°";
        }
        pullFromBottomActive = false;
        pullFromBottomDistance = 0;
      });
    }

    function scrollToBottom() {
      if (!messagesEl) return;
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // textarea ìë™ ë†’ì´ ì¡°ì ˆ
    function autoResizeInput() {
      inputEl.style.height = "auto";
      const maxHeight = 88;
      const newHeight = Math.min(inputEl.scrollHeight, maxHeight);
      inputEl.style.height = newHeight + "px";
    }

    inputEl.addEventListener("input", autoResizeInput);

    inputEl.addEventListener("compositionstart", () => {
      isComposing = true;
    });

    inputEl.addEventListener("compositionend", () => {
      isComposing = false;
      // ì¡°í•©ì´ ëë‚œ ë’¤ ë†’ì´ ë‹¤ì‹œ ê³„ì‚°
      autoResizeInput();
    });

    autoResizeInput();

    // ì…ë ¥ì°½ í¬ì»¤ìŠ¤ ì‹œ, í‚¤ë³´ë“œê°€ ì˜¬ë¼ì™€ë„ ë§ˆì§€ë§‰ ë©”ì‹œì§€ê°€ ë³´ì´ë„ë¡ ì‚´ì§ ë‚´ë ¤ì¤Œ
    inputEl.addEventListener("focus", () => {
      setTimeout(() => {
        scrollToBottom();
      }, 80);
    });

    // ì—”í„°ë¡œ ì „ì†¡, Shift+Enter ì¤„ë°”ê¿ˆ
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey && !isComposing) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener("click", () => {
      sendMessage();
    });

    async function sendMessage() {
      const rawText = inputEl.value;
      const text = rawText.trim();

      if (!text && !pendingAttachments.length) return;

      // ì´ë¯¸ ì „ì†¡ ì²˜ë¦¬ ì¤‘ì´ë¼ë©´ ì¤‘ë³µ í˜¸ì¶œ ë¬´ì‹œ
      if (isSending) return;
      isSending = true;

      // 1) ì²¨ë¶€ íŒŒì¼ì´ ìˆë‹¤ë©´ ë¨¼ì € ì„œë²„ë¡œ ì—…ë¡œë“œí•˜ì—¬ URLì„ í™•ë³´
      let uploadedInfos = [];
      if (pendingAttachments.length) {
        uploadedInfos = await uploadPendingFiles();
      }

      // ì²¨ë¶€íŒŒì¼ ì´ë¦„ì„ ë‚´ìš©ì— í•¨ê»˜ í‘œê¸° (ë‚˜ì¤‘ì— ë°±ì—”ë“œì—ì„œ í™œìš© ê°€ëŠ¥)
      const attachmentNames = pendingAttachments.map((att) => att.file?.name || "ì²¨ë¶€íŒŒì¼");
      let contentToSend = text;
      if (attachmentNames.length) {
        const label = "[ì²¨ë¶€: " + attachmentNames.join(", ") + "]";
        contentToSend = contentToSend ? contentToSend + "\n\n" + label : label;
      }

      // ì²¨ë¶€ ë©”íƒ€ë°ì´í„° (ë¡œì»¬ ê¸°ë¡ + ë°±ì—”ë“œ ì „ì†¡ìš©)
      const attachmentMeta = pendingAttachments.map((att, idx) => {
        const f = att.file;
        const uploaded = Array.isArray(uploadedInfos) ? uploadedInfos[idx] || {} : {};
        const type = uploaded.type || (f && f.type) || null;
        const isImage = !!(type && type.startsWith("image/"));
        const isVideo = !!(type && type.startsWith("video/"));
        let kind = "file";
        if (isImage) kind = "image";
        else if (isVideo) kind = "video";

        const size =
          typeof uploaded.size === "number"
            ? uploaded.size
            : typeof f?.size === "number"
            ? f.size
            : null;

        // Read optional server-side file path from upload response
        const serverPath =
          uploaded.server_path ||
          uploaded.path ||
          uploaded.local_path ||
          null;

        const name = uploaded.name || (f && f.name) || "ì²¨ë¶€íŒŒì¼";
        const url = uploaded.url || null;

        return {
          id: att.id,
          name,
          type,
          size,
          kind,
          url,
          server_path: serverPath,
        };
      });

      // 1) ë‚´ ë©”ì‹œì§€ ë°”ë¡œ ì¶”ê°€
      const userMsg = createMessage("user", contentToSend, undefined, attachmentMeta);
      chatHistory.push(userMsg);
      appendMessageToDOM(userMsg);
      saveHistory();

      inputEl.value = "";
      autoResizeInput();
      scrollToBottom();

      if (pendingAttachments.length) {
        clearPendingAttachments();
      }

      // 2) ë¶€ê°ë… íƒ€ì´í•‘ í‘œì‹œ
      showTypingIndicator();

      // 3) ë¶€ê°ë…ì—ê²Œ ì „ë‹¬
      try {
        const resp = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            messages: [{ role: "user", content: contentToSend }],
            attachments: attachmentMeta,
            upload_profile: uploadProfile,
          }),
        });

        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }

        const data = await resp.json();
        const replyText =
          data && typeof data.reply === "string" ? data.reply.trim() : "";

        if (replyText) {
          hideTypingIndicator();
          const assistantMsg = createMessage("assistant", replyText);
          chatHistory.push(assistantMsg);
          appendMessageToDOM(assistantMsg);
          saveHistory();
          scrollToBottom();
        } else {
          hideTypingIndicator();
        }
      } catch (e) {
        console.error(e);
        hideTypingIndicator();

        // ë§ˆì§€ë§‰ì— ë³´ë‚¸ ë‚´ ë©”ì‹œì§€ë¥¼ "ì „ì†¡ ì‹¤íŒ¨" ìƒíƒœë¡œ í‘œì‹œí•˜ê³  ì¬ì „ì†¡ ë²„íŠ¼ ì œê³µ
        markMessageAsFailed(userMsg.id);

        const errorMsg = createMessage(
          "assistant",
          "ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´. (HTTP ì˜¤ë¥˜)"
        );
        chatHistory.push(errorMsg);
        appendMessageToDOM(errorMsg);
        saveHistory();
        scrollToBottom();
      } finally {
        isSending = false;
      }
    }

    // ë§í’ì„  ë©”ë‰´ í† ê¸€ + í•€/ì‚­ì œ ë“±
    messagesInner.addEventListener("click", (e) => {
      const isMenuArea = !!e.target.closest(".bubble-menu");
      const toggle = e.target.closest(".bubble-menu-toggle");
      const menuBtn = e.target.closest(".bubble-menu button");
      const bubble = e.target.closest(".bubble");

      // ë”ë¸”íƒ­(ë”ë¸”í´ë¦­)ìœ¼ë¡œ í…ìŠ¤íŠ¸ ì„ íƒ
      if (bubble && !isMenuArea && !toggle && !menuBtn) {
        handleBubbleTap(bubble);
      }

      if (toggle) {
        const wrap = toggle.closest(".bubble-wrap");
        openBubbleMenuForWrap(wrap);
        return;
      }

      if (menuBtn) {
        const action = menuBtn.dataset.action;
        const wrap = menuBtn.closest(".bubble-wrap");
        const bubbleEl = wrap.querySelector(".bubble");
        const menu = wrap.querySelector(".bubble-menu");

        if (action === "pin") {
          const text = bubbleEl.textContent || "";
          pinText.textContent = text;
          pinCapsule.style.display = "flex";
        } else if (action === "copy") {
          const text = bubbleEl.textContent || "";
          if (text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(text).catch(() => {
                try {
                  const temp = document.createElement("textarea");
                  temp.value = text;
                  temp.style.position = "fixed";
                  temp.style.left = "-9999px";
                  document.body.appendChild(temp);
                  temp.select();
                  document.execCommand("copy");
                  document.body.removeChild(temp);
                } catch (_) {
                  // ignore
                }
              });
            } else {
              try {
                const temp = document.createElement("textarea");
                temp.value = text;
                temp.style.position = "fixed";
                temp.style.left = "-9999px";
                document.body.appendChild(temp);
                temp.select();
                document.execCommand("copy");
                document.body.removeChild(temp);
              } catch (_) {
                // ignore
              }
            }
          }
        } else if (action === "delete") {
          const row = wrap.closest(".msg-row");
          if (row) row.remove();
          if (wrap.dataset.id) {
            chatHistory = chatHistory.filter((m) => m.id !== wrap.dataset.id);
            saveHistory();
          }
        } else if (action === "edit") {
          inputEl.value = bubbleEl.textContent || "";
          inputEl.focus();
        } else if (action === "history") {
          console.log("history clicked for", wrap.dataset.id);
        }

        if (menu) {
          menu.classList.remove("show");
        }
      }
    });

    pinClearBtn.addEventListener("click", () => {
      pinCapsule.style.display = "none";
      pinText.textContent = "";
    });

    // ì²¨ë¶€ íŒŒì¼ / ì‚¬ì§„ ì„ íƒ
    attachBtn.addEventListener("click", () => {
      if (fileInput) {
        fileInput.click();
      }
    });

    if (fileInput) {
      fileInput.addEventListener("change", (e) => {
        const files = e.target.files;
        if (files && files.length) {
          addFilesToAttachments(files);
        }
      });
    }

    // ë°”ê¹¥ í´ë¦­ ì‹œ ì—´ë ¤ìˆëŠ” ë§í’ì„  ë©”ë‰´ ë‹«ê¸°
    document.addEventListener("click", (e) => {
      if (e.target.closest(".bubble-wrap")) return;
      document
        .querySelectorAll(".bubble-menu.show")
        .forEach((m) => m.classList.remove("show"));
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ ê¸°ì¤€ìœ¼ë¡œ ëŒ€í™” ë¶ˆëŸ¬ì˜¤ê¸°
    renderHistory().then(() => {
      // ì²« ì§„ì… ì‹œì—ëŠ” í•­ìƒ ë§ˆì§€ë§‰ ëŒ€í™”ê°€ ë³´ì´ë„ë¡ í•œ ë²ˆ ë” ê°•ì œë¡œ ìŠ¤í¬ë¡¤
      scrollToBottom();
      setTimeout(scrollToBottom, 150);
    });
  </script>
</body>
</html>