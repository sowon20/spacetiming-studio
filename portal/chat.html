<!doctype html>
<!--
  chat.html
  - ì‹œê³µê°„ ìŠ¤íŠœë””ì˜¤ í¬í„¸ ë©”ì¸ í™”ë©´
  - í”„ë¡ íŠ¸ ë¡œì§: portal/app.js
  - ë°±ì—”ë“œ: app.py (/api/chat, /api/history)
  - ìƒë‹¨ API ì‚¬ìš©ëŸ‰ ë°”/í¼ì„¼íŠ¸ ê°’ì€ í˜„ì¬ëŠ” ì‹œê°ì  ì¥ì‹ìš©ì´ë©°, ì‹¤ì œ ì‚¬ìš©ëŸ‰ê³¼ëŠ” ì—°ë™ë˜ì§€ ì•ŠëŠ”ë‹¤.
-->
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Sowon Â· Chat Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- iOS í™ˆ í™”ë©´ / í’€ìŠ¤í¬ë¦°ìš© ë©”íƒ€ -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="Spacetime Director" />
  <!-- (ì„ íƒ) ì•„ì´ì½˜ íŒŒì¼ì´ ìˆì„ ê²½ìš° ì´ ê²½ë¡œì— ë‘ë©´ í™ˆí™”ë©´ ì•„ì´ì½˜ ì‚¬ìš© ê°€ëŠ¥ -->
  <link rel="apple-touch-icon" href="/static/icons/app-icon-192.png" />
  <!-- ì•ˆë“œë¡œì´ë“œ ì£¼ì†Œì°½ ìƒ‰ìƒ ë“± -->
  <meta name="theme-color" content="#151713" />
  <style>
    :root {
      --vh: 1vh;
      --bg-cream: #f4f0ea;
      --bg-cream-soft: #efe9e0;
      --sage-deep: #323732;
      --sage-mid: #3d433e;
      --sage-soft: #5a635b;
      --sand-deep: #8b7965;
      --text-main: #262522;
      --text-soft: #96938e;
      --text-softer: #aaa7a2;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden; /* í˜ì´ì§€ ìì²´ëŠ” ìŠ¤í¬ë¡¤ ì•ˆ í•¨ */
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--bg-cream);
      color: var(--text-main);
      -webkit-text-size-adjust: 100%;
    }

    body {
      background: var(--bg-cream);
    }

    body.app-bg-forest {
      background-image: url("/static/backgrounds/forest_book.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    body.app-bg-forest::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: calc(env(safe-area-inset-top) + 80px);
      background: linear-gradient(
        to bottom,
        rgba(6, 7, 6, 0.98),
        rgba(6, 7, 6, 0.78),
        rgba(6, 7, 6, 0.0)
      );
      pointer-events: none;
      z-index: 0;
    }

    .app {
      height: 100dvh; /* iOS í™ˆ í™”ë©´ ì•±ì—ì„œ ë…¸ì¹˜ í¬í•¨ ì „ì²´ í™”ë©´ */
      padding: calc(env(safe-area-inset-top) - 4px) 12px calc(12px + env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    /* ìƒë‹¨ íŒ¨ë„ */

    .top-panel {
      background: rgba(12, 14, 12, 0.72);
      border-radius: 18px;
      padding: 10px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: #e8e3db;
      backdrop-filter: blur(16px) saturate(140%);
      -webkit-backdrop-filter: blur(16px) saturate(140%);
      box-shadow: 0 18px 40px rgba(5, 7, 6, 0.55);
      transition: max-height 0.25s ease, opacity 0.25s ease, background-color 0.2s ease, padding 0.2s ease, gap 0.2s ease;
      margin-top: -6px; /* ê·¸ë¼ë°ì´ì…˜ ì†ìœ¼ë¡œ ì‚´ì§ íŒŒë¬»í˜€ ë³´ì´ê²Œ */
      cursor: pointer;
    }

    /* ìƒë‹¨ íŒ¨ë„ì´ ìš”ì•½(ì ‘í˜) ìƒíƒœì¼ ë•Œ */
    .top-panel.collapsed {
      padding: 6px 10px;
      gap: 2px;
    }

    .top-panel.collapsed .top-title-sub {
      display: none;
    }

    .top-panel.collapsed .top-actions .icon-btn {
      display: none;
    }


    .top-panel-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .top-title-main {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .top-title-sub {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 2px;
    }

    .status-pill {
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(10, 12, 10, 0.32);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4bd37b;
    }

    .api-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      opacity: 0.9;
    }

    .api-label {
      opacity: 0.75;
    }

    .api-bar-wrap {
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: rgba(230, 224, 214, 0.22);
      overflow: hidden;
    }

    .api-bar {
      height: 100%;
      width: 32%;
      background: #e8e3db;
    }

    .top-actions {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }

    .icon-btn {
      border: none;
      outline: none;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: rgba(10, 10, 10, 0.4);
      color: #f5f2ec;
      font-size: 17px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }

    .icon-btn span {
      display: none;
    }

    .icon-btn:active {
      transform: scale(0.97);
    }

    /* í•€ ìº¡ìŠ */

    .pin-strip {
      min-height: 0;
    }

    .pin-capsule {
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(60, 67, 62, 0.22);
      font-size: 11px;
      color: #f2ede5;
    }

    .pin-capsule-main {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
    }

    .pin-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #f7e3a2;
      flex-shrink: 0;
    }

    .pin-text {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .pin-close {
      border: none;
      outline: none;
      background: none;
      color: #d9d3c8;
      font-size: 13px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .pin-close:active {
      transform: scale(0.9);
    }

    /* ë©”ì‹œì§€ ì˜ì—­ */

    .messages {
      flex: 1 1 auto;
      min-height: 0;
      padding: 8px 4px;
      border-radius: 18px;
      background: rgba(255, 255, 255, 0.16);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      font-size: 13px;
      position: relative;
    }
    /* ìœ„ë¡œ ëŒì–´ì„œ ìƒˆë¡œê³ ì¹¨ í‘œì‹œ */
    .pull-indicator {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 10px;
      text-align: center;
      font-size: 11px;
      padding: 4px 0;
      color: var(--text-soft);
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.15s ease, transform 0.15s ease, color 0.15s ease;
      pointer-events: none;
    }

    .pull-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }

    .pull-indicator.ready {
      color: #f7e3a2;
    }
    .messages-inner {
      padding: 4px 4px 72px;
    }

    .msg-row {
      display: flex;
      margin-bottom: 6px;
    }

    .msg-row.other {
      justify-content: flex-start;
    }

    .msg-row.me {
      justify-content: flex-end;
    }

    .bubble-wrap {
      max-width: 78%;
      position: relative;
      display: inline-flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
    }

    .bubble {
      position: relative;
      padding: 8px 10px;
      border-radius: 18px;
      font-size: 13px;
      line-height: 1.4;
      word-break: break-word;
      white-space: pre-wrap; /* Shift+Enter ì¤„ë°”ê¿ˆ ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ê¸° */
      transition: transform 0.08s ease-out, background-color 0.08s ease-out;
    }

    .bubble.other {
      background: var(--bg-cream-soft);
      color: var(--text-main);
      border-bottom-left-radius: 6px;
    }

    .bubble.me {
      background: var(--sage-mid);
      color: #f3eee5;
      border-bottom-right-radius: 6px;
    }

    .bubble.press-feedback {
      transform: scale(0.985);
    }

    .msg-row.other .bubble.press-feedback {
      background-color: rgba(239, 233, 224, 0.96);
    }

    .msg-row.me .bubble.press-feedback {
      background-color: #4a534b;
    }

    .bubble.typing {
      opacity: 0.9;
      letter-spacing: 0;
    }

    .typing-dots {
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: currentColor;
      opacity: 0.25;
      animation: typingBlink 1s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.15s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes typingBlink {
      0% {
        opacity: 0.2;
        transform: translateY(0);
      }
      30% {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      60% {
        opacity: 0.4;
        transform: translateY(0);
      }
      100% {
        opacity: 0.2;
        transform: translateY(0);
      }
    }


    .bubble-meta {
      font-size: 10px;
      color: #d6d2cc;
      align-self: flex-end;
      padding: 0 2px;
    }

    .msg-row.other .bubble-meta {
      align-self: flex-start;
      padding-left: 2px;
    }

    .msg-row.me .bubble-meta {
      align-self: flex-end;
      padding-right: 2px;
    }

    /* ë§í’ì„  ë©”ë‰´ */

    .bubble-menu-toggle {
      position: absolute;
      top: 50%;
      transform: translateY(-100%);
      width: 10px;
      height: 10px;
      border: none;
      border-radius: 999px;
      background: transparent;
      padding: 0;
      font-size: 0;
      opacity: 0;
      pointer-events: none; /* ë§í’ì„  ë¡±í”„ë ˆìŠ¤ ë©”ë‰´ë¡œ ëŒ€ì²´ */
    }
    .bubble.has-attachments {
      border: 1px solid rgba(255, 255, 255, 0.18); /* ì²¨ë¶€ê°€ ìˆëŠ” ë²„ë¸”ë§Œ ì‚´ì§ í…Œë‘ë¦¬ */
    }

    .msg-row.other .bubble.has-attachments {
      border-color: rgba(0, 0, 0, 0.08);
    }

    .bubble-attachments {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .bubble-attachment {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 6px;
      border-radius: 999px;
      font-size: 11px;
    }

    .msg-row.other .bubble-attachment {
      background: rgba(0, 0, 0, 0.03);
      color: var(--text-soft);
    }

    .msg-row.me .bubble-attachment {
      background: rgba(255, 255, 255, 0.12);
      color: #f5f2ec;
    }

    .bubble-attachment-icon {
      font-size: 11px;
      flex-shrink: 0;
    }

    .bubble-attachment-name {
      max-width: 140px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .msg-row.other .bubble-menu-toggle {
      right: -14px;
      left: auto;
      color: var(--bg-cream-soft); /* same tone as assistant bubble */
    }

    .msg-row.me .bubble-menu-toggle {
      left: -14px;
      right: auto;
      color: var(--sage-mid); /* same tone as my bubble */
    }

    .bubble-menu-toggle:active {
      opacity: 0.8; /* ì‚´ì§ë§Œ ëˆŒë¦¬ëŠ” ëŠë‚Œ, ìœ„ì¹˜ëŠ” ê·¸ëŒ€ë¡œ */
    }

    .bubble-menu {
      position: absolute;
      right: -6px;
      top: 22px;
      display: none;
      background: rgba(45, 50, 46, 0.9); /* ê¸°ë³¸: ìƒëŒ€ ë©”ì‹œì§€ìš© */
      border-radius: 999px;
      padding: 3px 6px;
      font-size: 11px;
      color: #f2eee5;
      white-space: nowrap;
      gap: 4px;
      align-items: center;
    }
    .msg-row.me .bubble-menu {
      left: -2px;
      right: auto;
      background: rgb(21, 21, 21); /* ë‚´ ë©”ì‹œì§€ìš©: ë” ì§„í•œ ë°°ê²½ */
    }

    .bubble-menu.show {
      display: inline-flex;
    }

    .bubble-menu button {
      border: none;
      background: none;
      padding: 3px 4px;
      border-radius: 999px;
      color: inherit;
      cursor: pointer;
    }

    .bubble-menu button:active {
      transform: scale(0.9);
    }

    /* ì‘ì„± ì˜ì—­ */

    .composer {
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .attach-strip {
      display: none;
      padding: 6px 0;
      border-radius: 10px;
      background: transparent;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .attach-strip-inner {
      display: inline-flex;
      gap: 8px;
    }

    .attach-pill {
      width: 80px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
    }

    .attach-thumb {
      position: relative;
      width: 100%;
      padding-top: 100%; /* ì •ì‚¬ê°í˜• */
      border-radius: 12px;
      background: rgba(244, 240, 234, 0.96);
      overflow: hidden;
    }
    .attach-thumb img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .attach-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: none;
      background: rgba(0, 0, 0, 0.5);
      color: #f8f4ed;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .attach-title {
      display: none;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      text-align: center;
      color: var(--text-main);
    }

    .composer-hint {
      font-size: 10px;
      color: var(--text-soft);
      padding: 0 2px;
    }

    .upload-profile-row {
      font-size: 10px;
      color: var(--text-soft);
      padding: 0 2px 2px;
      display: flex;
      justify-content: flex-end;
    }

    .upload-profile-row label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .upload-profile-row select {
      font-size: 10px;
      border-radius: 999px;
      padding: 2px 8px;
      border: none;
      outline: none;
      background: rgba(244, 240, 234, 0.9);
      color: var(--text-main);
    }

    .composer-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .attach-btn {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: none;
      outline: none;
      background: rgba(244, 240, 234, 0.98); /* ê±°ì˜ í°ìƒ‰ */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      cursor: pointer;
      color: var(--sage-mid);
      flex-shrink: 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
    }

    .attach-btn:active {
      transform: scale(0.95);
    }

    .input-shell {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      padding: 6px 8px 6px 10px;
      border-radius: 16px;
      background: rgba(244, 240, 234, 0.9);
    }

    textarea.input {
      flex: 1;
      border: none;
      background: transparent;
      resize: none;
      outline: none;
      font: inherit;
      font-size: 16px;
      line-height: 1.4;
      max-height: 88px;
      color: var(--text-main);
    }

    .send-btn {
      border: none;
      outline: none;
      margin-left: 6px;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: var(--sage-mid);
      color: #f3eee5;
      font-size: 14px;
    }

    .send-btn:active {
      transform: scale(0.95);
    }

    @media (min-width: 768px) {
      .app {
        max-width: 480px;
        margin: 0 auto;
      }
    }
    .messages::-webkit-scrollbar {
      width: 4px;
    }

    .messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages::-webkit-scrollbar-thumb {
      background: rgba(90, 99, 91, 0.55);
      border-radius: 999px;
    }

    .messages {
      scrollbar-width: thin;
      scrollbar-color: rgba(90, 99, 91, 0.55) transparent;
    }
    /* ê°€ë¡œ ëª¨ë“œì—ì„œëŠ” ì „ì²´ ì•± ìˆ¨ê¸°ê³  ê²½ê³ ë§Œ í‘œì‹œ */
.landscape-warning {
  display: none;
}

@media (orientation: landscape) and (max-width: 900px) {
  .app {
    display: none;
  }

  .landscape-warning {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
    background: rgba(10, 10, 10, 0.9);
    color: #f4f0ea;
    font-size: 14px;
    text-align: center;
  }
}
  </style>
</head>
<body class="app-bg-forest">
  <div class="app">
    <input type="file" id="bgImageInput" accept="image/*" style="display:none" />
    <!-- ìƒë‹¨ ì„¸ì´ì§€ íŒ¨ë„ -->
    <header class="top-panel collapsed">
      <div class="top-panel-row">
        <div>
          <div class="top-title-main">SPACETIME DIRECTOR</div>
          <div class="top-title-sub">ë¶€ê°ë… Â· ê°œì¸ ì„¸ì…˜</div>
        </div>
        <div class="top-actions">
          <div class="status-pill">
            <span class="status-dot"></span>
            <span>ONLINE</span>
          </div>
          <button class="icon-btn" type="button" id="bgChangeBtn">
            ğŸ¨<span>BG</span>
          </button>
          <button class="icon-btn" type="button">
            ğŸ“<span>Call</span>
          </button>
        </div>
      </div>
      <div class="api-row">
        <div class="api-label">API ì‚¬ìš©ëŸ‰</div>
        <div class="api-bar-wrap">
          <div class="api-bar" id="apiBar"></div>
        </div>
        <div class="api-label" id="apiLabel">32%</div>
      </div>
    </header>

    <!-- í•€ ìº¡ìŠ ì˜ì—­ -->
    <section class="pin-strip">
      <div class="pin-capsule" id="pinCapsule">
        <div class="pin-capsule-main">
          <div class="pin-dot"></div>
          <div class="pin-text" id="pinText">í•€ ëœ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ìš”ì•½ë¼ìš”.</div>
        </div>
        <button class="pin-close" type="button" id="pinClearBtn">âœ•</button>
      </div>
    </section>

    <!-- ë©”ì‹œì§€ ì˜ì—­ -->
    <main class="messages" id="messages">
      <div class="messages-inner" id="messagesInner">
        <!-- ì‹¤ì œ ë©”ì‹œì§€ëŠ” JSì—ì„œ ë Œë”ë§ -->
      </div>
      <div class="pull-indicator" id="pullIndicator">â†‘ ì˜¬ë ¤ì„œ ìƒˆë¡œê³ ì¹¨</div>
    </main>

    <!-- ì…ë ¥ ì˜ì—­ -->
    <section class="composer">
      <input type="file" id="fileInput" multiple style="display:none" />
      <!-- ì²¨ë¶€ ë¯¸ë¦¬ë³´ê¸° (í˜„ì¬ëŠ” ë¡œì»¬ ë¯¸ë¦¬ë³´ê¸° ì „ìš©, ì‹¤ì œ ì—…ë¡œë“œëŠ” app.js TODO ì°¸ê³ ) -->
      <div class="attach-strip" id="attachStrip">
        <div class="attach-strip-inner" id="attachStripInner">
          <!-- JSë¡œ ì±„ì›Œì§ -->
        </div>
      </div>

      <div class="upload-profile-row">
        <label>
          ì €ì¥ ìœ„ì¹˜
          <select id="uploadProfileSelect">
            <option value="local_default">ê¸°ë³¸ (ë¡œì»¬)</option>
            <option value="gdrive_main">êµ¬ê¸€ ë“œë¼ì´ë¸Œ (ë©”ì¸)</option>
          </select>
        </label>
      </div>

      <div class="composer-row">
        <button class="attach-btn" type="button" id="attachBtn">ï¼‹</button>
        <div class="input-shell">
          <textarea
            id="input"
            class="input"
            rows="1"
            placeholder="ë©”ì‹œì§€ ì…ë ¥â€¦"
          ></textarea>
          <button class="send-btn" type="button" id="sendBtn">â¤</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    const messagesInner = document.getElementById("messagesInner");
    const pinCapsule = document.getElementById("pinCapsule");
    const pinText = document.getElementById("pinText");
    const pinClearBtn = document.getElementById("pinClearBtn");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const attachBtn = document.getElementById("attachBtn");
    const attachStrip = document.getElementById("attachStrip");
    const attachStripInner = document.getElementById("attachStripInner");
    const fileInput = document.getElementById("fileInput");
    const messagesEl = document.getElementById("messages");
    const pullIndicator = document.getElementById("pullIndicator");
    const uploadProfileSelect = document.getElementById("uploadProfileSelect");

    const bodyEl = document.body;
    const bgImageInput = document.getElementById("bgImageInput");
    const bgChangeBtn = document.getElementById("bgChangeBtn");

    const TYPING_ROW_ID = "assistant-typing";

    const STORAGE_KEY = "director_chat_messages_v2";
    const UPLOAD_PROFILE_KEY = "director_upload_profile";
    let uploadProfile = "local_default";
    let chatHistory = [];
    let pendingAttachments = [];
    const INITIAL_HISTORY_BATCH = 40;
    const HISTORY_PAGE_SIZE = 40;
    let visibleStartIndex = 0;
    let isLoadingOlder = false;
    let currentBgObjectUrl = null;

    // ì—…ë¡œë“œ í”„ë¡œí•„ ì´ˆê¸°í™” (localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°)
    if (uploadProfileSelect) {
      const savedProfile = localStorage.getItem(UPLOAD_PROFILE_KEY);
      if (savedProfile) {
        uploadProfile = savedProfile;
      }
      uploadProfileSelect.value = uploadProfile;
      uploadProfileSelect.addEventListener("change", (e) => {
        const value = e.target.value || "local_default";
        uploadProfile = value;
        try {
          localStorage.setItem(UPLOAD_PROFILE_KEY, uploadProfile);
        } catch (_) {
          // ignore
        }
      });
    }

    // ë°°ê²½ ì´ë¯¸ì§€ ë³€ê²½: ì•„ì´í° ì‚¬ì§„ì²©ì—ì„œ ì„ íƒí•´ì„œ í˜„ì¬ ì„¸ì…˜ ë°°ê²½ìœ¼ë¡œ ì‚¬ìš©
    if (bgChangeBtn && bgImageInput && bodyEl) {
      bgChangeBtn.addEventListener("click", () => {
        bgImageInput.click();
      });

      bgImageInput.addEventListener("change", (e) => {
        const input = e.target;
        const file = input.files && input.files[0];
        if (!file || !file.type || !file.type.startsWith("image/")) {
          // ì´ë¯¸ì§€ê°€ ì•„ë‹ˆë©´ ë¬´ì‹œ
          input.value = "";
          return;
        }

        // ì´ì „ ë°°ê²½ URL ì •ë¦¬
        if (currentBgObjectUrl) {
          try {
            URL.revokeObjectURL(currentBgObjectUrl);
          } catch (_) {
            // ignore
          }
          currentBgObjectUrl = null;
        }

        const url = URL.createObjectURL(file);
        currentBgObjectUrl = url;

        // body ë°°ê²½ì„ ì„ íƒí•œ ì´ë¯¸ì§€ë¡œ êµì²´ (ë…¸ì¹˜ ì•„ë˜ ì „ì²´ë¥¼ ì±„ìš°ëŠ” ìš©ë„)
        bodyEl.style.backgroundImage = `url("${url}")`;
        bodyEl.style.backgroundSize = "cover";
        bodyEl.style.backgroundPosition = "center";
        bodyEl.style.backgroundRepeat = "no-repeat";

        // ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒí•´ë„ change ì´ë²¤íŠ¸ê°€ ëœ¨ë„ë¡ ì´ˆê¸°í™”
        input.value = "";
      });
    }

    // ìƒë‹¨ íŒ¨ë„ ìš”ì•½/í¼ì¹¨ í† ê¸€ (ìš”ì•½ ëª¨ë“œ: ë¶€ê°ë… ìƒíƒœ + API ì‚¬ìš©ëŸ‰ ìœ„ì£¼)
    const topPanel = document.querySelector('.top-panel');
    if (topPanel) {
      let isTopPanelCollapsed = false;
      topPanel.addEventListener("click", (e) => {
        // ì•„ì´ì½˜ ë²„íŠ¼(ë°°ê²½/ì „í™”)ì„ ëˆ„ë¥¼ ë•ŒëŠ” ì ‘í˜ í† ê¸€ì„ ë§‰ëŠ”ë‹¤
        if (e.target.closest(".icon-btn")) {
          return;
        }
        isTopPanelCollapsed = !isTopPanelCollapsed;
        if (isTopPanelCollapsed) {
          topPanel.classList.add("collapsed");
        } else {
          topPanel.classList.remove("collapsed");
        }
      });
    }

    async function fetchServerHistory(limit = 200) {
      try {
        const resp = await fetch(`/api/history?limit=${limit}`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        // ì§€ì› í˜•íƒœ: [ {..}, {..} ] ë˜ëŠ” { messages: [..] }
        const raw = Array.isArray(data)
          ? data
          : Array.isArray(data?.messages)
          ? data.messages
          : [];

        return raw.map((item, idx) => {
          const ts =
            item.timestamp !== undefined && item.timestamp !== null
              ? item.timestamp
              : item.time !== undefined
              ? item.time
              : null;
          return {
            id:
              item.id ||
              String(ts || Date.now()) + "_" + idx.toString(),
            role: item.role || "assistant",
            content: item.content || "",
            timestamp: ts,
          };
        });
      } catch (e) {
        console.warn("server history failed", e);
        return [];
      }
    }

    function loadHistory() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.warn("chat history load failed", e);
        return [];
      }
    }

    function saveHistory() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory));
      } catch (e) {
        console.warn("chat history save failed", e);
      }
    }

    function formatTime(ts) {
      // ì„œë²„ì—ì„œ ì˜¤ëŠ” HH:MM ë¬¸ìì—´ì¸ ê²½ìš°
      if (typeof ts === "string") {
        if (ts.length >= 5 && ts[2] === ":") {
          return ts.slice(0, 5);
        }
        const dFromStr = new Date(ts);
        if (!isNaN(dFromStr.getTime())) {
          const hh = String(dFromStr.getHours()).padStart(2, "0");
          const mm = String(dFromStr.getMinutes()).padStart(2, "0");
          return `${hh}:${mm}`;
        }
      }

      // ìˆ«ì íƒ€ì„ìŠ¤íƒ¬í”„(Date.now())ì¸ ê²½ìš°
      if (typeof ts === "number") {
        const d = new Date(ts);
        if (!isNaN(d.getTime())) {
          const hh = String(d.getHours()).padStart(2, "0");
          const mm = String(d.getMinutes()).padStart(2, "0");
          return `${hh}:${mm}`;
        }
      }

      // ê·¸ ì™¸(ì—†ê±°ë‚˜ ì´ìƒí•œ ê°’)ëŠ” í˜„ì¬ ì‹œê°ìœ¼ë¡œ ëŒ€ì²´
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      return `${hh}:${mm}`;
    }

    function createMessage(role, content, timestamp, attachments) {
      return {
        id: Date.now().toString() + Math.random().toString(16).slice(2),
        role,
        content,
        timestamp: timestamp ?? Date.now(),
        attachments: Array.isArray(attachments) ? attachments : [],
      };
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // ì•„ì£¼ ê°€ë²¼ìš´ ì¸ë¼ì¸ ë§ˆí¬ë‹¤ìš´: **bold**, *italic*, `code`
    function renderContent(raw) {
      if (!raw) return "";
      let text = escapeHtml(raw);

      // bold: **text**
      text = text.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
      // italic: *text*
      text = text.replace(/\*(.+?)\*/g, "<em>$1</em>");
      // inline code: `code`
      text = text.replace(/`([^`]+)`/g, "<code>$1</code>");

      return text;
    }

    function truncateFileName(name, maxLen = 24) {
      const str = String(name || "ì²¨ë¶€íŒŒì¼");
      if (str.length <= maxLen) return str;
      const extIndex = str.lastIndexOf(".");
      if (extIndex > 0 && extIndex < str.length - 1) {
        const base = str.slice(0, extIndex);
        const ext = str.slice(extIndex);
        if (base.length > maxLen - ext.length - 3) {
          return base.slice(0, maxLen - ext.length - 3) + "..." + ext;
        }
        return base + "..." + ext;
      }
      return str.slice(0, maxLen - 3) + "...";
    }

    const LONG_PRESS_MS = 500;
    const LONG_PRESS_MOVE_TOLERANCE = 10;
    let longPressTimer = null;
    let longPressTargetWrap = null;
    let longPressTargetBubble = null;
    let longPressStartX = 0;
    let longPressStartY = 0;

    let lastTapTime = 0;
    let lastTapBubble = null;
    const DOUBLE_TAP_MS = 350;

    function openBubbleMenuForWrap(wrap) {
      if (!wrap) return;
      const menu = wrap.querySelector(".bubble-menu");
      if (!menu) return;
      const allMenus = document.querySelectorAll(".bubble-menu");
      allMenus.forEach((m) => {
        if (m !== menu) m.classList.remove("show");
      });
      menu.classList.add("show");
    }

    function cancelLongPress() {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
      if (longPressTargetBubble) {
        longPressTargetBubble.classList.remove("press-feedback");
      }
      longPressTargetWrap = null;
      longPressTargetBubble = null;
    }

    function handlePressStart(event) {
      const bubble = event.target.closest(".bubble");
      if (!bubble) return;
      const wrap = bubble.closest(".bubble-wrap");
      if (!wrap) return;

      // ì´ì „ ë¡±í”„ë ˆìŠ¤ ìƒíƒœ ì´ˆê¸°í™”
      cancelLongPress();

      longPressTargetBubble = bubble;
      bubble.classList.add("press-feedback");

      // iOSì—ì„œ í…ìŠ¤íŠ¸ ë‹ë³´ê¸°/ê¸°ë³¸ ë¡±í”„ë ˆìŠ¤ ë©”ë‰´ê°€ ëœ¨ì§€ ì•Šë„ë¡ ë§‰ê¸°
      if (event.touches && event.cancelable) {
        event.preventDefault();
      }

      longPressTargetWrap = wrap;
      const point = event.touches ? event.touches[0] : event;
      longPressStartX = point.clientX;
      longPressStartY = point.clientY;

      longPressTimer = setTimeout(() => {
        openBubbleMenuForWrap(longPressTargetWrap);
        longPressTimer = null;
      }, LONG_PRESS_MS);
    }

    function handlePressMove(event) {
      if (!longPressTimer) return;
      const point = event.touches ? event.touches[0] : event;
      if (!point) return;
      const dx = Math.abs(point.clientX - longPressStartX);
      const dy = Math.abs(point.clientY - longPressStartY);
      if (dx > LONG_PRESS_MOVE_TOLERANCE || dy > LONG_PRESS_MOVE_TOLERANCE) {
        cancelLongPress();
      }
    }

    function handlePressEnd() {
      cancelLongPress();
    }

    function handleBubbleTap(bubble) {
      const now = Date.now();
      if (lastTapBubble === bubble && now - lastTapTime < DOUBLE_TAP_MS) {
        const range = document.createRange();
        range.selectNodeContents(bubble);
        const selection = window.getSelection();
        if (selection) {
          selection.removeAllRanges();
          selection.addRange(range);
        }
      }
      lastTapBubble = bubble;
      lastTapTime = now;
    }

    function clearPendingAttachments() {
      pendingAttachments.forEach((att) => {
        if (att.url) {
          URL.revokeObjectURL(att.url);
        }
      });
      pendingAttachments = [];
      attachStripInner.innerHTML = "";
      attachStrip.style.display = "none";
    }

    function addFilesToAttachments(files) {
      const list = Array.from(files || []);
      if (!list.length) return;

      list.forEach((file) => {
        const id = Date.now().toString() + Math.random().toString(16).slice(2);
        const url = URL.createObjectURL(file);
        const isImage = file.type && file.type.startsWith("image/");

        const att = { id, file, url, isImage };
        pendingAttachments.push(att);

        attachStrip.style.display = "block";

        const pill = document.createElement("div");
        pill.className = "attach-pill";
        pill.dataset.id = id;

        const thumb = document.createElement("div");
        thumb.className = "attach-thumb";

        if (isImage) {
          const img = document.createElement("img");
          img.src = url;
          img.alt = file.name || "image";
          thumb.appendChild(img);
        } else {
          const label = document.createElement("div");
          label.style.position = "absolute";
          label.style.inset = "0";
          label.style.display = "flex";
          label.style.alignItems = "center";
          label.style.justifyContent = "center";
          label.style.fontSize = "10px";
          label.style.color = "var(--text-soft)";
          const name = (file.name || "íŒŒì¼").split(".");
          label.textContent = name.length > 1 ? name.pop().toUpperCase() : "FILE";
          thumb.appendChild(label);
        }

        const remove = document.createElement("button");
        remove.className = "attach-remove";
        remove.type = "button";
        remove.textContent = "âœ•";
        remove.addEventListener("click", () => {
          pill.remove();
          pendingAttachments = pendingAttachments.filter((x) => {
            if (x.id === id) {
              if (x.url) URL.revokeObjectURL(x.url);
              return false;
            }
            return true;
          });
          if (!attachStripInner.children.length) {
            attachStrip.style.display = "none";
          }
        });
        thumb.appendChild(remove);

        const title = document.createElement("div");
        title.className = "attach-title";
        title.textContent = file.name || "ì²¨ë¶€íŒŒì¼";

        pill.appendChild(thumb);
        pill.appendChild(title);
        attachStripInner.appendChild(pill);
      });

      if (fileInput) {
        fileInput.value = "";
      }
    }

    function showTypingIndicator() {
      if (document.getElementById(TYPING_ROW_ID)) return;

      const row = document.createElement("div");
      row.className = "msg-row other";
      row.id = TYPING_ROW_ID;

      const wrap = document.createElement("div");
      wrap.className = "bubble-wrap";

      const bubble = document.createElement("div");
      bubble.className = "bubble other typing";

      const dots = document.createElement("div");
      dots.className = "typing-dots";

      for (let i = 0; i < 3; i++) {
        const dot = document.createElement("span");
        dot.className = "typing-dot";
        dots.appendChild(dot);
      }

      bubble.appendChild(dots);
      wrap.appendChild(bubble);
      row.appendChild(wrap);
      messagesInner.appendChild(row);
      scrollToBottom();
    }

    function hideTypingIndicator() {
      const typingRow = document.getElementById(TYPING_ROW_ID);
      if (typingRow) {
        typingRow.remove();
      }
    }

    function buildMessageRowElement(msg) {
      const row = document.createElement("div");
      row.className = "msg-row " + (msg.role === "assistant" ? "other" : "me");

      const wrap = document.createElement("div");
      wrap.className = "bubble-wrap";
      wrap.dataset.id = msg.id;

      const toggle = document.createElement("button");
      toggle.className = "bubble-menu-toggle";
      toggle.type = "button";
      toggle.textContent = "â‹¯";

      const bubble = document.createElement("div");
      bubble.className = "bubble " + (msg.role === "assistant" ? "other" : "me");
      bubble.innerHTML = renderContent(msg.content);

      if (Array.isArray(msg.attachments) && msg.attachments.length) {
        bubble.classList.add("has-attachments");
        const attWrap = document.createElement("div");
        attWrap.className = "bubble-attachments";

        msg.attachments.forEach((att) => {
          const chip = document.createElement("div");
          chip.className = "bubble-attachment";

          const icon = document.createElement("span");
          icon.className = "bubble-attachment-icon";
          const kind = att.kind || (att.type && att.type.startsWith("image/") ? "image" : "file");
          icon.textContent =
            kind === "image" ? "ğŸ–¼" : kind === "video" ? "ğŸ¬" : "ğŸ“";

          const label = document.createElement("span");
          label.className = "bubble-attachment-name";
          label.textContent = truncateFileName(att.name || "ì²¨ë¶€íŒŒì¼");

          chip.appendChild(icon);
          chip.appendChild(label);
          attWrap.appendChild(chip);
        });

        bubble.appendChild(attWrap);
      }

      const meta = document.createElement("div");
      meta.className = "bubble-meta" + (msg.role === "assistant" ? "" : " me");
      meta.textContent = formatTime(msg.timestamp);

      const menu = document.createElement("div");
      menu.className = "bubble-menu";
      ["pin", "copy", "edit", "delete", "history"].forEach((action) => {
        const btn = document.createElement("button");
        btn.dataset.action = action;
        btn.textContent =
          action === "pin"
            ? "í•€"
            : action === "copy"
            ? "ë³µì‚¬"
            : action === "edit"
            ? "ìˆ˜ì •"
            : action === "delete"
            ? "ì‚­ì œ"
            : "ê¸°ë¡";
        menu.appendChild(btn);
      });

      wrap.appendChild(toggle);
      wrap.appendChild(bubble);
      wrap.appendChild(meta);
      wrap.appendChild(menu);
      row.appendChild(wrap);
      return row;
    }
    // ë¡±í”„ë ˆìŠ¤(ëª¨ë°”ì¼/ë°ìŠ¤í¬íƒ‘)ë¡œ ë§í’ì„  ë©”ë‰´ ì—´ê¸°
    messagesInner.addEventListener("touchstart", handlePressStart, { passive: false });
    messagesInner.addEventListener("touchmove", handlePressMove, { passive: true });
    messagesInner.addEventListener("touchend", handlePressEnd);
    messagesInner.addEventListener("touchcancel", handlePressEnd);

    messagesInner.addEventListener("mousedown", (e) => {
      if (e.button !== 0) return;
      handlePressStart(e);
    });
    messagesInner.addEventListener("mousemove", handlePressMove);
    messagesInner.addEventListener("mouseup", handlePressEnd);
    messagesInner.addEventListener("mouseleave", handlePressEnd);

    function appendMessageToDOM(msg, options = {}) {
      const { prepend = false } = options;
      const row = buildMessageRowElement(msg);
      if (prepend && messagesInner.firstChild) {
        messagesInner.insertBefore(row, messagesInner.firstChild);
      } else if (prepend) {
        messagesInner.appendChild(row);
      } else {
        messagesInner.appendChild(row);
      }
    }

    async function renderHistory() {
      // 1ìˆœìœ„: ì„œë²„ ê³µìš© íˆìŠ¤í† ë¦¬
      let msgs = await fetchServerHistory(1000);

      // ì„œë²„ì— ì•„ì§ ê¸°ë¡ì´ ì—†ë‹¤ë©´ â†’ ì˜ˆì „ localStorage ë°±ì—… ì‚¬ìš©
      if (!msgs.length) {
        msgs = loadHistory();
      }

      chatHistory = msgs;
      messagesInner.innerHTML = "";

      const total = chatHistory.length;
      visibleStartIndex = Math.max(0, total - INITIAL_HISTORY_BATCH);

      for (let i = visibleStartIndex; i < total; i++) {
        appendMessageToDOM(chatHistory[i]);
      }

      // ì„œë²„ ê¸°ì¤€ìœ¼ë¡œ localStorageë„ ë®ì–´ì¨ì„œ ë°±ì—…ì²˜ëŸ¼ ì‚¬ìš©
      saveHistory();
      scrollToBottom();
    }

    async function loadOlderMessages() {
      if (isLoadingOlder) return;
      if (!messagesEl) return;
      if (visibleStartIndex <= 0) return;

      isLoadingOlder = true;

      const prevStart = Math.max(0, visibleStartIndex - HISTORY_PAGE_SIZE);
      const prevScrollTop = messagesEl.scrollTop;
      const prevScrollHeight = messagesEl.scrollHeight;

      for (let i = visibleStartIndex - 1; i >= prevStart; i--) {
        appendMessageToDOM(chatHistory[i], { prepend: true });
      }

      visibleStartIndex = prevStart;

      const newScrollHeight = messagesEl.scrollHeight;
      const heightDiff = newScrollHeight - prevScrollHeight;
      messagesEl.scrollTop = prevScrollTop + heightDiff;

      isLoadingOlder = false;
    }

    // --- ìœ„ë¡œ ì˜¬ë ¤ì„œ ìƒˆë¡œê³ ì¹¨ (ëŒ€í™” ë§¨ ì•„ë˜ ê¸°ì¤€, ë¹„ìƒìš©) ---
    const PULL_THRESHOLD = 60; // px
    let pullStartY = null;
    let pullDelta = 0;
    let isPulling = false;

    function isAtBottom() {
      if (!messagesEl) return false;
      const tolerance = 2;
      return (
        messagesEl.scrollTop + messagesEl.clientHeight >=
        messagesEl.scrollHeight - tolerance
      );
    }

    function resetPullIndicator() {
      if (!pullIndicator) return;
      pullIndicator.classList.remove("show", "ready");
      pullIndicator.textContent = "â†‘ ì˜¬ë ¤ì„œ ìƒˆë¡œê³ ì¹¨";
    }

    function triggerHardRefresh() {
      // ë¹„ìƒìš©: í˜ì´ì§€ ì „ì²´ ìƒˆë¡œê³ ì¹¨
      window.location.reload();
    }

    if (messagesEl && pullIndicator) {
      messagesEl.addEventListener(
        "touchstart",
        (e) => {
          if (!isAtBottom()) {
            pullStartY = null;
            isPulling = false;
            return;
          }
          if (!e.touches || !e.touches.length) return;
          pullStartY = e.touches[0].clientY;
          pullDelta = 0;
          isPulling = true;
        },
        { passive: true }
      );

      messagesEl.addEventListener(
        "touchmove",
        (e) => {
          if (!isPulling || pullStartY === null) return;
          if (!e.touches || !e.touches.length) return;

          const currentY = e.touches[0].clientY;
          // ì•„ë˜ì—ì„œ ìœ„ë¡œ ì˜¬ë¦´ ë•Œ: ì†ê°€ë½ì´ ìœ„ë¡œ ê°€ë‹ˆê¹Œ ê°’ì´ ì‘ì•„ì§
          pullDelta = pullStartY - currentY;

          if (pullDelta <= 0 || !isAtBottom()) {
            resetPullIndicator();
            return;
          }

          pullIndicator.classList.add("show");

          if (pullDelta >= PULL_THRESHOLD) {
            pullIndicator.classList.add("ready");
            pullIndicator.textContent = "â†» ë†“ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨";
          } else {
            pullIndicator.classList.remove("ready");
            pullIndicator.textContent = "â†‘ ì˜¬ë ¤ì„œ ìƒˆë¡œê³ ì¹¨";
          }
        },
        { passive: true }
      );

      const endPull = () => {
        if (!isPulling) {
          pullStartY = null;
          pullDelta = 0;
          resetPullIndicator();
          return;
        }

        const isReady =
          pullDelta >= PULL_THRESHOLD && pullIndicator.classList.contains("ready");

        pullStartY = null;
        pullDelta = 0;
        isPulling = false;
        resetPullIndicator();

        if (isReady) {
          triggerHardRefresh();
        }
      };

      messagesEl.addEventListener("touchend", endPull);
      messagesEl.addEventListener("touchcancel", endPull);
    }

    if (messagesEl) {
      messagesEl.addEventListener("scroll", () => {
        if (messagesEl.scrollTop <= 40 && !isLoadingOlder && visibleStartIndex > 0) {
          loadOlderMessages();
        }
      });
    }

    function scrollToBottom() {
      if (!messagesEl) return;
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // textarea ìë™ ë†’ì´ ì¡°ì ˆ
    function autoResizeInput() {
      inputEl.style.height = "auto";
      const maxHeight = 88;
      const newHeight = Math.min(inputEl.scrollHeight, maxHeight);
      inputEl.style.height = newHeight + "px";
    }

    inputEl.addEventListener("input", autoResizeInput);
    autoResizeInput();

    // ì—”í„°ë¡œ ì „ì†¡, Shift+Enter ì¤„ë°”ê¿ˆ
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener("click", () => {
      sendMessage();
    });

    async function sendMessage() {
      const rawText = inputEl.value;
      const text = rawText.trim();

      if (!text && !pendingAttachments.length) return;

      // ì²¨ë¶€íŒŒì¼ ì´ë¦„ì„ ë‚´ìš©ì— í•¨ê»˜ í‘œê¸° (ë‚˜ì¤‘ì— ë°±ì—”ë“œì—ì„œ í™œìš© ê°€ëŠ¥)
      const attachmentNames = pendingAttachments.map((att) => att.file?.name || "ì²¨ë¶€íŒŒì¼");
      let contentToSend = text;
      if (attachmentNames.length) {
        const label = "[ì²¨ë¶€: " + attachmentNames.join(", ") + "]";
        contentToSend = contentToSend ? contentToSend + "\n\n" + label : label;
      }

      // ì²¨ë¶€ ë©”íƒ€ë°ì´í„° (ë¡œì»¬ ê¸°ë¡ + ë°±ì—”ë“œ ì „ì†¡ìš©)
      const attachmentMeta = pendingAttachments.map((att) => {
        const f = att.file;
        const type = (f && f.type) || null;
        const isImage = !!(type && type.startsWith("image/"));
        const isVideo = !!(type && type.startsWith("video/"));
        let kind = "file";
        if (isImage) kind = "image";
        else if (isVideo) kind = "video";

        return {
          id: att.id,
          name: (f && f.name) || "ì²¨ë¶€íŒŒì¼",
          type,
          size: typeof f?.size === "number" ? f.size : null,
          kind,
        };
      });

      // 1) ë‚´ ë©”ì‹œì§€ ë°”ë¡œ ì¶”ê°€
      const userMsg = createMessage("user", contentToSend, undefined, attachmentMeta);
      chatHistory.push(userMsg);
      appendMessageToDOM(userMsg);
      saveHistory();

      inputEl.value = "";
      autoResizeInput();
      scrollToBottom();

      if (pendingAttachments.length) {
        clearPendingAttachments();
      }

      // 2) ë¶€ê°ë… íƒ€ì´í•‘ í‘œì‹œ
      showTypingIndicator();

      // 3) ë¶€ê°ë…ì—ê²Œ ì „ë‹¬
      try {
        const resp = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            messages: [{ role: "user", content: contentToSend }],
            attachments: attachmentMeta,
            upload_profile: uploadProfile,
          }),
        });

        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }

        const data = await resp.json();
        const replyText =
          data && typeof data.reply === "string" ? data.reply.trim() : "";

        if (replyText) {
          hideTypingIndicator();
          const assistantMsg = createMessage("assistant", replyText);
          chatHistory.push(assistantMsg);
          appendMessageToDOM(assistantMsg);
          saveHistory();
          scrollToBottom();
        } else {
          hideTypingIndicator();
        }
      } catch (e) {
        console.error(e);
        hideTypingIndicator();
        const errorMsg = createMessage(
          "assistant",
          "ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´. (HTTP ì˜¤ë¥˜)"
        );
        chatHistory.push(errorMsg);
        appendMessageToDOM(errorMsg);
        saveHistory();
        scrollToBottom();
      }
    }

    // ë§í’ì„  ë©”ë‰´ í† ê¸€ + í•€/ì‚­ì œ ë“±
    messagesInner.addEventListener("click", (e) => {
      const isMenuArea = !!e.target.closest(".bubble-menu");
      const toggle = e.target.closest(".bubble-menu-toggle");
      const menuBtn = e.target.closest(".bubble-menu button");
      const bubble = e.target.closest(".bubble");

      // ë”ë¸”íƒ­(ë”ë¸”í´ë¦­)ìœ¼ë¡œ í…ìŠ¤íŠ¸ ì„ íƒ
      if (bubble && !isMenuArea && !toggle && !menuBtn) {
        handleBubbleTap(bubble);
      }

      if (toggle) {
        const wrap = toggle.closest(".bubble-wrap");
        openBubbleMenuForWrap(wrap);
        return;
      }

      if (menuBtn) {
        const action = menuBtn.dataset.action;
        const wrap = menuBtn.closest(".bubble-wrap");
        const bubbleEl = wrap.querySelector(".bubble");
        const menu = wrap.querySelector(".bubble-menu");

        if (action === "pin") {
          const text = bubbleEl.textContent || "";
          pinText.textContent = text;
          pinCapsule.style.display = "flex";
        } else if (action === "copy") {
          const text = bubbleEl.textContent || "";
          if (text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(text).catch(() => {
                try {
                  const temp = document.createElement("textarea");
                  temp.value = text;
                  temp.style.position = "fixed";
                  temp.style.left = "-9999px";
                  document.body.appendChild(temp);
                  temp.select();
                  document.execCommand("copy");
                  document.body.removeChild(temp);
                } catch (_) {
                  // ignore
                }
              });
            } else {
              try {
                const temp = document.createElement("textarea");
                temp.value = text;
                temp.style.position = "fixed";
                temp.style.left = "-9999px";
                document.body.appendChild(temp);
                temp.select();
                document.execCommand("copy");
                document.body.removeChild(temp);
              } catch (_) {
                // ignore
              }
            }
          }
        } else if (action === "delete") {
          const row = wrap.closest(".msg-row");
          if (row) row.remove();
          if (wrap.dataset.id) {
            chatHistory = chatHistory.filter((m) => m.id !== wrap.dataset.id);
            saveHistory();
          }
        } else if (action === "edit") {
          inputEl.value = bubbleEl.textContent || "";
          inputEl.focus();
        } else if (action === "history") {
          console.log("history clicked for", wrap.dataset.id);
        }

        if (menu) {
          menu.classList.remove("show");
        }
      }
    });

    pinClearBtn.addEventListener("click", () => {
      pinCapsule.style.display = "none";
      pinText.textContent = "";
    });

    // ì²¨ë¶€ íŒŒì¼ / ì‚¬ì§„ ì„ íƒ
    attachBtn.addEventListener("click", () => {
      if (fileInput) {
        fileInput.click();
      }
    });

    if (fileInput) {
      fileInput.addEventListener("change", (e) => {
        const files = e.target.files;
        if (files && files.length) {
          addFilesToAttachments(files);
        }
      });
    }

    // ë°”ê¹¥ í´ë¦­ ì‹œ ì—´ë ¤ìˆëŠ” ë§í’ì„  ë©”ë‰´ ë‹«ê¸°
    document.addEventListener("click", (e) => {
      if (e.target.closest(".bubble-wrap")) return;
      document
        .querySelectorAll(".bubble-menu.show")
        .forEach((m) => m.classList.remove("show"));
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ ê¸°ì¤€ìœ¼ë¡œ ëŒ€í™” ë¶ˆëŸ¬ì˜¤ê¸°
    renderHistory();
  </script>
</body>
</html>